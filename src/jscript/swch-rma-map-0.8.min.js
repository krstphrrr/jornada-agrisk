var ContentController=function(c,h,f,g,j,d,e,l,m,p,b,k,a,o,r,n,q){this.content=c;this.menu=h;this.menuLink=f;this.menuOption=g;this.overlay=j;this.loader=d;this.mapContainer=e;this.themeContainer=l;this.themeHeader=m;this.themePage=p;this.chartPage=b;this.themeButton=k;this.chartButton=a;this.themeOneForm=o;this.themeTwoForm=r;this.themeOneCharts=n;this.themeTwoCharts=q;this.themeManager=null;this.map=null;this.chartManager=null;this.tour=null;this.userSurvey=null;this.downloadManager=null;this.chartView=false;$("body").click({obj:this},function(s){$(this).addClass("no-outline")});$("body").keydown({obj:this},function(s){if(s.keyCode===9){$(this).removeClass("no-outline")}});$(this.menuLink).focus({obj:this},function(t){var s=t.data.obj;$(s.menu).addClass("active")});$(this.menuLink).blur({obj:this},function(t){var s=t.data.obj;$(s.menu).removeClass("active")});$(this.menuOption).focus({obj:this},function(t){var s=t.data.obj;$(s.menu).addClass("active")});$(this.menuOption).blur({obj:this},function(t){var s=t.data.obj;$(s.menu).removeClass("active")});$(this.themeHeader).click({obj:this},function(t){var s=t.data.obj;s.toggleThemePanel()});$(this.themeHeader).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.themeButton).click({obj:this},function(t){var s=t.data.obj;s.chartView=false;$(s.chartPage).hide();$(s.themePage).show();$(s.chartButton).focus()});$(this.themeButton).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.chartButton).click({obj:this},function(t){var s=t.data.obj;s.chartView=true;$(s.themePage).hide();$(s.themeContainer).addClass("expanded");if(s.map){s.map.updateCharts()}});$(this.chartButton).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}})};ContentController.prototype.addThemeManager=function(a){this.themeManager=a;this.themeManager.controller=this};ContentController.prototype.addMap=function(a){this.map=a;this.map.controller=this};ContentController.prototype.addChartManager=function(a){this.chartManager=a;this.chartManager.controller=this};ContentController.prototype.addTour=function(a){this.tour=a;this.tour.controller=this};ContentController.prototype.addUserSurvey=function(a){this.userSurvey=a;this.userSurvey.controller=this};ContentController.prototype.addDownloadManager=function(a){this.downloadManager=a;this.downloadManager.controller=this};ContentController.prototype.loadContent=function(){if(this.map){this.map.loadMap()}};ContentController.prototype.startLoadAnimation=function(){$(this.overlay).removeClass("hidden");$(this.loader).html("<div class='loader-container'><p>Loading...</p><div class='loader'></div></div>")};ContentController.prototype.stopLoadAnimation=function(){$(this.overlay).addClass("hidden");$(this.loader).empty()};ContentController.prototype.resizeMap=function(a){if($(this.content).hasClass("more-map")){$(this.content).removeClass("more-map");a.text("More Map")}else{$(this.content).addClass("more-map");a.text("Less Map")}};ContentController.prototype.toggleTheme=function(a){if(this.themeManager&&(a==1||a==2)){if(a==1){$(this.themeTwoForm).hide();$(this.themeOneForm).show();$(this.themeTwoCharts).removeClass("active");$(this.themeOneCharts).addClass("active")}else{if(a==2){$(this.themeOneForm).hide();$(this.themeTwoForm).show();$(this.themeOneCharts).removeClass("active");$(this.themeTwoCharts).addClass("active")}}this.themeManager.setThemeNumber(a)}};ContentController.prototype.toggleThemePanel=function(){$(this.themeContainer).toggleClass("expanded");if(this.themeManager){this.themeManager.closeForms();this.themeManager.scrollToTop()}};ContentController.prototype.hideThemePanel=function(){$(this.themeContainer).removeClass("expanded");if(this.themeManager){this.themeManager.closeForms();this.themeManager.scrollToTop()}};ContentController.prototype.updateCharts=function(c,b,a){if(this.chartManager){if(this.chartView){this.chartManager.fetchChartData(c,b,a)}}};var Content=function(){this.controller=null};var RMAMap=function(a,g,p,r,q,o,e,c,b,d,h,f,k,j,l,m,n){this.container=a;this.map=g;this.themeOneLabel=p;this.themeTwoLabel=r;this.themeTitle=q;this.themeCaption=o;this.legend=e;this.legendItem=c;this.legendBox=b;this.legendLabel=d;this.popupContainer=document.getElementById(h.substring(1));this.mapResizeButton=f;this.searchBoxContainer=k;this.searchBoxAnchor=j;this.searchBox=l;this.searchButton=m;this.searchCloseButton=n;this.olMap;this.polygonStroke;this.labelFill;this.selectStroke;this.selectStyle;this.styleFunction;this.basemap;this.overlay;this.featureOverlay;this.currentSelection="";this.currentSelectionName="";this.countySource;this.stateSource;this.themeOneLayer;this.themeTwoLayer;this.stateList=[];this.countyList=[];this.themeOne={loaded:false,name:"Not specified",data:[],digitCount:0,styleClasses:[],reportingUnit:"county",labelResolution:1000,measure:"actual"};this.themeTwo={loaded:false,name:"Not specified",data:[],digitCount:0,styleClasses:[],reportingUnit:"county",labelResolution:1000,measure:"actual"};this.activeTheme=this.themeOne;this.currentTheme="";this.currentThemeNumber=1;this.mapLoaded=false;this.searchBoxReady=false;$(this.mapResizeButton).click({obj:this},function(s){var t=s.data.obj;if(t.controller){t.controller.resizeMap($(this))}if(t.olMap){t.olMap.updateSize()}});$(this.mapResizeButton).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){var t=s.data.obj;if(t.controller){t.controller.resizeMap($(this))}if(t.olMap){t.olMap.updateSize()}}});$(this.searchButton).click({obj:this},function(s){var t=s.data.obj;if(!t.searchBoxReady){t.initializeSearchBox()}$(t.searchBox).val("");$(t.searchBoxContainer).toggleClass("expanded")});$(this.searchButton).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.searchCloseButton).click({obj:this},function(s){var t=s.data.obj;$(t.searchButton).focus();$(t.searchBox).val("");$(t.searchBoxContainer).removeClass("expanded")});$(this.searchCloseButton).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.themeOneLabel).click({obj:this},function(s){var t=s.data.obj;if(!$(this).hasClass("active")){t.currentThemeNumber=1;$(this).addClass("active");$(t.themeTwoLabel).removeClass("active");t.activeTheme=t.themeOne;t.controller.toggleTheme(1);t.themeTwoLayer.setVisible(false);t.themeOneLayer.setVisible(true);t.updateCaptionOnLayerChange();t.refreshPolygonLayers();t.updateLegend(t.activeTheme.styleClasses,t.activeTheme.digitCount);if(t.themeOne.reportingUnit!=t.themeTwo.reportingUnit){t.searchBoxReady=false}t.resetSearchBox()}});$(this.themeOneLabel).keydown({obj:this},function(s){if((s.keyCode===13||s.keyCode===32)){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.themeTwoLabel).click({obj:this},function(s){var t=s.data.obj;if(!$(this).hasClass("active")){t.currentThemeNumber=2;$(this).addClass("active");$(t.themeOneLabel).removeClass("active");t.activeTheme=t.themeTwo;t.controller.toggleTheme(2);t.themeOneLayer.setVisible(false);t.themeTwoLayer.setVisible(true);t.updateCaptionOnLayerChange();t.refreshPolygonLayers();t.updateLegend(t.activeTheme.styleClasses,t.activeTheme.digitCount);t.resetSearchBox()}});$(this.themeTwoLabel).keydown({obj:this},function(s){if((s.keyCode===13||s.keyCode===32)){$(this).trigger("click");$("body").removeClass("no-outline")}})};RMAMap.prototype=Object.create(Content.prototype);RMAMap.prototype.constructor=RMAMap;RMAMap.prototype.loadContent=function(){this.loadMap()};RMAMap.prototype.loadMap=function(){var f=this;this.polygonStroke=new ol.style.Stroke({color:"#FFF",width:1});this.labelFill=new ol.style.Fill({color:"#000"});this.selectStroke=new ol.style.Stroke({color:"#000",width:3});this.selectStyle=new ol.style.Style({stroke:this.selectStroke});var j=new ol.style.Style({stroke:new ol.style.Stroke({color:"#222",width:1})});var g=new ol.style.Fill({color:"000"});this.styleFunction=(function(){return function(n,t){var q=false;if(t<f.activeTheme.labelResolution){q=true;var r=new ol.style.Style({text:new ol.style.Text({text:n.get("UNIT_NAME"),textAlign:"center",textBaseline:"middle",font:"normal 12px Arial, sans-serif",rotation:0,fill:f.labelFill})})}var u=f.activeTheme.data[n.get("UNIT_CODE")];var s=new ol.style.Style({stroke:f.polygonStroke});if(u){var l=f.activeTheme.styleClasses.length;for(var p=0;p<l;p++){if(u>=f.activeTheme.styleClasses[p].low&&(u<=f.activeTheme.styleClasses[p].high||Math.abs(u-f.activeTheme.styleClasses[p].high)<1e-10)){var m=f.activeTheme.styleClasses[p].color;var o=new ol.style.Fill({color:"rgb("+m.red+","+m.green+","+m.blue+")"});s=new ol.style.Style({stroke:f.polygonStroke,fill:o});break}}}if(q){return[s,r]}else{return[s]}}}());var a=new ol.Attribution({html:"Basemap provided by ESRI. Sources: Esri, HERE, DeLorme, MapmyIndia, © OpenStreetMap contributors, and the GIS user community. "});this.basemap=new ol.layer.Tile({id:"Gray",source:new ol.source.XYZ({attributions:[a],url:"https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"})});a=new ol.Attribution({html:"State and county boundaries provided by the U.S. Census Bureau. "});var d=new ol.source.Vector({projection:"EPSG:3857",url:"data/cb_2015_us_county_20m.json",format:new ol.format.GeoJSON(),attributions:[a]});this.countySource=new ol.source.ImageVector({source:d,style:this.styleFunction});this.themeOneLayer=new ol.layer.Image({type:"county",source:this.countySource});this.themeTwoLayer=new ol.layer.Image({type:"county",source:this.countySource,visible:false});var k=new ol.source.Vector({projection:"EPSG:3857",url:"data/cb_2015_us_state_20m.json",format:new ol.format.GeoJSON(),attributions:[a]});this.stateSource=new ol.source.ImageVector({source:k,style:this.styleFunction});var h=new ol.layer.Vector({type:"static",source:k,style:j});this.overlay=new ol.Overlay(({element:this.popupContainer,autoPan:false}));var b=ol.proj.transform([-98.5795,39.8283],"EPSG:4326","EPSG:3857");var c=ol.control.defaults({rotate:false});var e=ol.interaction.defaults({altShiftDragRotate:false,pinchRotate:false});this.olMap=new ol.Map({controls:c,interactions:e,layers:[this.basemap,this.themeTwoLayer,this.themeOneLayer,h],overlays:[this.overlay],target:document.getElementById(this.map.substring(1)),view:new ol.View({center:b,zoom:4,minZoom:2})});this.featureOverlay=new ol.layer.Vector({source:new ol.source.Vector(),map:this.olMap,style:this.selectStyle});this.olMap.on("click",function(l){f.displayFeatureInfo(l.pixel,l.originalEvent.ctrlKey)});if(!this.mapLoaded){if(this.controller){if(this.controller.themeManager){this.controller.themeManager.fetchMapData()}}}this.countySource.set("loadend",$(f.searchBoxContainer).show());this.countySource.set("loadend",this.mapLoaded=true)};RMAMap.prototype.displayFeatureInfo=function(d,a){var c=this;var b=this.olMap.forEachFeatureAtPixel(d,function(e,f){if(f){if(c.activeTheme.reportingUnit==f.get("type")){return e}}});this.selectFeature(b,!a,false)};RMAMap.prototype.resetSearchBox=function(){this.searchBoxReady=false;$(this.searchBox).val("");$(this.searchBoxContainer).removeClass("expanded")};RMAMap.prototype.onSearchSelection=function(b){var a=this.getFeatureByID(b);$(this.searchButton).focus();$(this.searchBox).blur();$(this.searchBox).val("");$(this.searchBoxContainer).removeClass("expanded");this.selectFeature(a,true,true)};RMAMap.prototype.getFeatureByID=function(e){var c=null;var b;if(this.activeTheme.reportingUnit=="county"&&this.countySource){c=this.countySource.getSource().getFeatures()}else{if(this.activeTheme.reportingUnit=="state"&&this.stateSource){c=this.stateSource.getSource().getFeatures()}}if(c){var a=c.length;for(var d=0;d<a;d++){b=c[d];if((b.get("UNIT_CODE"))==e){break}}}return b};RMAMap.prototype.updateCharts=function(){if(this.controller){var a=this.getSelectedFeatureList();this.controller.updateCharts(this.currentThemeNumber,a,this.currentSelectionName)}};RMAMap.prototype.getSelectedFeatureList=function(){var b=this.featureOverlay.getSource().getFeatures();var a=b.length;var d=[];for(var c=0;c<a;c++){d.push(b[c].get("UNIT_CODE"))}return d};RMAMap.prototype.selectFeature=function(c,k,g){if(c){var l=false;var e=this.featureOverlay.getSource().getFeatures();var d=e.length;for(var f=0;f<d;f++){if(e[f]===c){l=true;break}}if(k){this.featureOverlay.getSource().clear()}else{if(l){this.featureOverlay.getSource().removeFeature(c)}}if(l){this.updateCaption()}else{this.featureOverlay.getSource().addFeature(c);this.updateCaption();if(g){var j=c.getGeometry();if(j){var b=j.getExtent();var a=[(b[0]+b[2])/2,(b[1]+b[3])/2];var m=this.olMap.getView();var h=ol.animation.pan({duration:1000,source:m.getCenter()});this.olMap.beforeRender(h);m.setCenter(a)}}}this.updateCharts()}else{this.clearSelections()}};RMAMap.prototype.clearSelections=function(a){this.featureOverlay.getSource().clear();this.currentSelection="";this.currentSelectionName="";this.updateCharts();this.updateCaption()};RMAMap.prototype.updateCaptionOnLayerChange=function(){if(this.themeOne.reportingUnit==this.themeTwo.reportingUnit){this.updateCaption();this.updateCharts()}else{this.clearSelections()}};RMAMap.prototype.updateCaption=function(){var a=$(this.themeCaption);var c=this.featureOverlay.getSource().getFeatures();featureCount=c.length;if(featureCount>1){var j=0;var k,l,f;var e=0;var g;for(var d=0;d<featureCount;d++){id=c[d].get("UNIT_CODE");if(this.activeTheme.data[id]){k=Number(this.activeTheme.data[id]);j=j+k;l=String(k).split(".");if(l.length==2){f=l[1].length;if(d==0||f<e){e=f}}}}if(this.activeTheme.measure=="per_mile"||this.activeTheme.measure=="per_km"){j=j/featureCount}var g=Math.pow(10,e)/10;j=Math.round(j*g)/g;if(this.activeTheme.digitCount==0){var l=String(j).split(".");g=Math.pow(10,0);j=Math.floor(j*g)/g;var h="";if(l.length==2){if(Number(l[1])!=0){h="."+l[1]}}j=String(j).replace(/(.)(?=(\d{3})+$)/g,"$1,");j=j+h}this.currentSelection="";this.currentSelectionName="Multiple";a.html(this.currentSelectionName+": "+j)}else{if(featureCount==1){var b=c[0];this.currentSelection=b.get("UNIT_CODE");var k=this.activeTheme.data[this.currentSelection];if(this.activeTheme.reportingUnit=="county"){this.currentSelectionName=b.get("UNIT_NAME")+" County, "+b.get("STATE")}else{this.currentSelectionName=b.get("UNIT_NAME")}if(!k){k=0}else{var l=String(k).split(".");var g=Math.pow(10,0);k=Math.floor(k*g)/g;var h="";if(l.length==2){if(Number(l[1])!=0){h="."+l[1]}}k=String(k).replace(/(.)(?=(\d{3})+$)/g,"$1,");k=k+h}a.html(this.currentSelectionName+": "+k)}else{if(this.activeTheme.reportingUnit=="state"){a.html("All states")}else{a.html("All counties")}}}};RMAMap.prototype.updateTheme=function(l,k,j,f,c,g,e,d){var a=this.objectToArray(j);this.resetSearchBox();if(l==1){this.currentTheme=k;this.themeOne.loaded=true;this.themeOne.name=k;this.themeOne.data=j;this.themeOne.reportingUnit=g;this.themeOne.measure=e;var h;$(this.themeTitle).html(k);if(g=="state"){this.themeOne.labelResolution=4000;this.themeOneLayer.set("type","state");this.themeOneLayer.setSource(this.stateSource)}else{this.themeOne.labelResolution=1000;this.themeOneLayer.set("type","county");this.themeOneLayer.setSource(this.countySource)}if(k==this.themeTwo.name&&g==this.themeTwo.reportingUnit&&this.themeTwo.data){var b=this.objectToArray(this.themeTwo.data);a=a.concat(b)}this.themeOne.digitCount=0;if(d){this.themeOne.digitCount=this.getDigitCount(a)}if(f=="equal interval"){h=this.getIntervalClasses(a,c)}else{if(f=="percentile"){h=this.getPercentileClasses(a,c)}else{if(f=="fixed interval"){h=this.getFixedClasses(a,c)}}}this.themeOne.styleClasses=h;this.activeTheme=this.themeOne;this.updateLegend(h,this.themeOne.digitCount);this.clearSelections();this.refreshPolygonLayers()}else{if(l==2){this.currentTheme=k;this.themeTwo.loaded=true;this.themeTwo.name=k;this.themeTwo.data=j;this.themeTwo.reportingUnit=g;this.themeTwo.measure=e;var h;$(this.themeTitle).html(k);if(g=="state"){this.themeTwo.labelResolution=5000;this.themeTwoLayer.set("type","state");this.themeTwoLayer.setSource(this.stateSource)}else{this.themeTwo.labelResolution=1000;this.themeTwoLayer.set("type","county");this.themeTwoLayer.setSource(this.countySource)}if(k==this.themeOne.name&&g==this.themeOne.reportingUnit&&this.themeOne.data){var b=this.objectToArray(this.themeOne.data);a=a.concat(b)}this.themeTwo.digitCount=0;if(d){this.themeTwo.digitCount=this.getDigitCount(a)}if(f=="equal interval"){h=this.getIntervalClasses(a,c)}else{if(f=="percentile"){h=this.getPercentileClasses(a,c)}else{if(f=="fixed interval"){h=this.getFixedClasses(a,c)}}}this.themeTwo.styleClasses=h;this.activeTheme=this.themeTwo;this.updateLegend(h,this.themeTwo.digitCount);this.clearSelections();this.refreshPolygonLayers()}}this.controller.stopLoadAnimation()};RMAMap.prototype.objectToArray=function(b){var a=[];for(var c in b){if(b.hasOwnProperty(c)){a.push(Number(b[c]))}}return a};RMAMap.prototype.updateLegend=function(n,c){var b=n.length;var k=$(this.legend);if(k.length>0){var f=k.find(this.legendItem);f.hide();if(b>0){var m=Math.pow(10,c+1)/10;var g,e,a,h,l,d;for(i=0;i<b;i++){g=b-1-i;e=f.eq(i);a=e.find(this.legendBox);h=e.find(this.legendLabel);color="rgb("+n[g].color.red+","+n[g].color.green+","+n[g].color.blue+")";l=n[g].low;d=n[g].high;l=Math.round(l*m)/m;d=Math.round(d*m)/m;if(c==0){l=String(l).replace(/(.)(?=(\d{3})+$)/g,"$1,");d=String(d).replace(/(.)(?=(\d{3})+$)/g,"$1,")}range=l+"&ndash;"+d;a.css("background-color",color);h.html(range);e.css("display","inline-block")}}}};RMAMap.prototype.getIntervalClasses=function(a,b){var m=[];if(a.length>0&&b>0&&b<11){a.sort(function(n,o){return n-o});var j=a[0];var h=a[a.length-1];var g=(h-j)/b;var d=j;var k,e,c,l;for(var f=0;f<b;f++){k=d+g;if(f==b-1){e=k}else{e=Number(k.toPrecision(3))}c=this.getColorClass(b,f+1);l={low:Number(d.toPrecision(3)),high:e,color:c};m.push(l);d=k}}return m};RMAMap.prototype.getPercentileClasses=function(a,b,d){var m=[];if(a.length>0&&b>0&&b<11){a.sort(function(n,o){return n-o});var h=100/b;var j=h;var e=a[0];var k,f,c,l;for(var g=0;g<b;g++){k=d3.quantile(a,j/100);if(g==b-1){f=k}else{f=Number(k.toPrecision(3))}c=this.getColorClass(b,g+1);l={low:Number(e.toPrecision(3)),high:f,color:c};m.push(l);e=k;j=j+h}}return m};RMAMap.prototype.getFixedClasses=function(a,d){var q=[];if(a.length>0&&d>0&&d<11){var r=[];for(var h=0;h<a.length;h++){if(a[h]>0){r.push(a[h])}}r.sort(function(s,t){return s-t});var l=0;var g=0;var k,f,e,p;var n=r[0];var m=r[r.length-1];var c=[9.999999999999999e-12,5e-11,1e-10,5e-10,1e-09,5e-09,1e-08,5e-08,1e-07,5e-07,1e-06,5e-06,1e-05,5e-05,0.0001,0.0005,0.001,0.005,0.01,0.05,0.1,0.5,1,5,10,50,100,500,1000,5000,10000,50000,100000,500000,1000000,5000000,10000000,50000000,100000000,500000000,1000000000,5000000000,10000000000,50000000000,100000000000,500000000000,1000000000000];for(h=0;h<c.length;h++){if(n<=c[h]){l=h;break}}for(h=0;h<c.length;h++){if(m<c[h]){g=h-1;break}}if(h==c.length){g=c.length-1}var j=g-l;var o=1;if(j<d){d=j+1}else{if(j>d*2){o=Math.floor(j/d)}}var b=g-d*o+o;for(h=0;h<d;h++){if(h==0){k=n}else{k=c[b+h*o]}if(h==d-1){f=m}else{f=c[b+h*o+o]}e=this.getColorClass(d,h+1);p={low:k,high:f,color:e};q.push(p)}}return q};RMAMap.prototype.percentile=function(d,c){var b=d.length;var e=(c/100)*(b-1)+1;var a=Math.floor(e);if(a>=b){result=d[b-1]}else{value1=d[a-1];value2=d[a];result=value1+e%1*(value2-value1)}return result};RMAMap.prototype.getDigitCount=function(a){var c=0;if(a.length>0){var g=[];for(var d=0;d<a.length;d++){if(a[d]>0){g.push(a[d])}}g.sort(function(h,j){return h-j});var f=g[0];var e=g[g.length-1];var b=e-f;if(b==0){c=0}else{if(b<1e-06){c=11}else{if(b<1e-05){c=10}else{if(b<0.0001){c=9}else{if(b<0.001){c=8}else{if(b<0.01){c=7}else{if(b<0.1){c=6}else{if(b<0){c=5}else{if(b<10){c=4}else{if(b<100){c=3}else{c=0}}}}}}}}}}}return c};RMAMap.prototype.getColorClass=function(a,e){var b={red:224,green:224,blue:224};if(e>0&&e<11){var f=1/a;var c=f/2;var h=e*f-c;var g={red:175,green:234,blue:212};var d={red:14,green:84,blue:57};b.red=Math.round(g.red+h*(d.red-g.red));b.green=Math.round(g.green+h*(d.green-g.green));b.blue=Math.round(g.blue+h*(d.blue-g.blue))}return b};RMAMap.prototype.refreshPolygonLayers=function(){this.olMap.getLayers().forEach(function(a){a.getSource().changed()})};RMAMap.prototype.initializeSearchBox=function(){var c=this;var a=$(this.searchBoxAnchor);var b=$(this.searchBox);b.val("");var d=[];if(this.activeTheme.reportingUnit=="state"){if(this.stateList.length==0){this.stateList=this.getStates()}d=this.stateList}else{if(this.countyList.length==0){this.countyList=this.getCounties()}d=this.countyList}$(this.searchBox).autocomplete({appendTo:a,source:d,minLength:4,delay:500,focus:function(e,f){return false},select:function(e,f){b.val(f.item.label);c.onSearchSelection(f.item.value);return false},open:function(e,m){var g=$(e.target);var k=g.autocomplete("widget");var l=k.position().top;var f=k.height();var h=g.height()*2;var j=l-f-h-4;k.css("top",j+"px")}});this.searchBoxReady=true};RMAMap.prototype.getCounties=function(){var b=[];var c;function a(d,e){if(d.state<e.state){return -1}if(d.state>e.state){return 1}if(d.label<e.label){return -1}if(d.label>e.label){return 1}return 0}if(this.countySource){this.countySource.getSource().forEachFeature(function(d){c={label:d.get("UNIT_NAME")+", "+d.get("STATE_NAME"),value:d.get("UNIT_CODE")};b.push(c)})}b=b.sort(a);return b};RMAMap.prototype.getStates=function(){var c=[];var b;function a(d,e){if(d.label<e.label){return -1}if(d.label>e.label){return 1}return 0}if(this.stateSource){this.stateSource.getSource().forEachFeature(function(d){b={label:d.get("UNIT_NAME"),value:d.get("UNIT_CODE")};c.push(b)})}c=c.sort(a);return c};var ThemeManager=function(l,m,n,v,u,t,x,p,z,j,d,w,r,q,A,k,e,a,f,g,o,s,h,y,c,b){this.contentContainer=l;this.formContainer=m;this.form=n;this.sectionTab=v;this.section=u;this.scrollableClass=t;this.truncatedClass=x;this.metricCaption=p;this.yearCaption=z;this.commodityCaption=j;this.causeCaption=d;this.settingsCaption=w;this.parameterList=r;this.metricOption=q;this.yearOption=A;this.commodityOption=k;this.causeOption=e;this.allOption=a;this.classCountMenu=f;this.classMethodMenu=g;this.measurementUnitMenu=o;this.reportingUnitMenu=s;this.clearButton=h;this.updateButton=y;this.cancelButton=c;this.bookend=b;this.currentTheme=1;this.thematicData=null;this.themes=[{},{}];this.themeCaptions=[{metric:"",dates:"",commodity:"",cause:"",settings:""},{metric:"",dates:"",commodity:"",cause:"",settings:""}];$(this.classCountMenu).val(6);$(this.classMethodMenu).val("fixed interval");$(this.measurementUnitMenu).val("actual");$(this.reportingUnitMenu).val("county");$(this.sectionTab).click({obj:this},function(B){var D=B.data.obj;if(!$(this).hasClass("active")){var E=$(D.sectionTab);var C=E.index($(this));E.removeClass("active");$(this).addClass("active");D.showForms(C)}else{D.closeForms()}});$(this.sectionTab).keydown({obj:this},function(B){if(B.keyCode===13||B.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.parameterList).keydown({obj:this},function(B){if(B.keyCode===32){B.preventDefault();var C=B.data.obj;$(this).find("li").eq(0).focus()}});$(this.parameterList+" li").keydown({obj:this},function(B){if(B.keyCode===38){B.preventDefault();$(this).prev().focus()}});$(this.parameterList+" li").keydown({obj:this},function(B){if(B.keyCode===40){B.preventDefault();$(this).next().focus()}});$(this.metricOption).click({obj:this},function(B){var D=B.data.obj;if(!$(this).hasClass("selected")){var C=$(this).parents(D.form);var E=C.find(D.metricOption);E.removeClass("selected");$(this).addClass("selected")}});$(this.metricOption).keydown({obj:this},function(B){if(B.keyCode===13||B.keyCode===32){$(this).trigger("click")}});$(this.yearOption).click({obj:this},function(C){var E=C.data.obj;var D=$(this).parents(E.form);if($(this).hasClass(E.allOption.substring(1))){var F=D.find(E.yearOption);F.removeClass("active").removeClass("selected");$(this).addClass("selected")}else{if($(this).hasClass("selected")){var F=D.find(E.yearOption);var B=D.find(E.yearOption+E.allOption);F.removeClass("active").removeClass("selected");B.addClass("selected")}else{var B=D.find(E.yearOption+E.allOption);B.removeClass("selected");$(this).toggleClass("active");E.updateYears(D)}}});$(this.yearOption).keydown({obj:this},function(B){if(B.keyCode===13||B.keyCode===32){$(this).trigger("click")}});$(this.commodityOption).click({obj:this},function(C){var E=C.data.obj;var D=$(this).parents(E.form);var F=D.find(E.commodityOption);var H=$(this).attr("value");if($(this).hasClass("selected")){E.unSelectOptionsByValue(F,H);var G=D.find(E.commodityOption+".selected");if(G.length==0){var B=D.find(E.commodityOption+E.allOption);B.addClass("selected")}}else{if($(this).hasClass(E.allOption.substring(1))){F.removeClass("selected")}else{var B=D.find(E.commodityOption+E.allOption);B.removeClass("selected")}E.selectOptionsByValue(F,H)}});$(this.commodityOption).keydown({obj:this},function(B){if(B.keyCode===13||B.keyCode===32){$(this).trigger("click")}});$(this.causeOption).click({obj:this},function(C){var E=C.data.obj;var D=$(this).parents(E.form);var F=D.find(E.causeOption);var H=$(this).attr("value");if($(this).hasClass("selected")){E.unSelectOptionsByValue(F,H);var G=D.find(E.causeOption+".selected");if(G.length==0){var B=D.find(E.causeOption+E.allOption);B.addClass("selected")}}else{var D=$(this).parents(E.form);if($(this).hasClass(E.allOption.substring(1))){var F=D.find(E.causeOption);F.removeClass("selected")}else{var B=D.find(E.causeOption+E.allOption);B.removeClass("selected")}E.selectOptionsByValue(F,H)}});$(this.causeOption).keydown({obj:this},function(B){if(B.keyCode===13||B.keyCode===32){$(this).trigger("click")}});$(this.clearButton).click({obj:this},function(C){var F=C.data.obj;var D=$(F.form).eq(F.currentTheme-1);if(D.length>0){var B=$(F.sectionTab+".active");var E=$(F.sectionTab).index(B);if(E>-1){var G=D.find(F.section).eq(E);if(G.length>0){G.find(F.yearOption).removeClass("active").removeClass("selected");G.find(F.commodityOption).removeClass("selected");G.find(F.causeOption).removeClass("selected");G.find(F.allOption).addClass("selected")}}}});$(this.clearButton).keydown({obj:this},function(B){if(B.keyCode===13||B.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.updateButton).click({obj:this},function(B){var C=B.data.obj;C.fetchMapData();C.closeForms()});$(this.updateButton).keydown({obj:this},function(B){if(B.keyCode===13||B.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.cancelButton).click({obj:this},function(B){var C=B.data.obj;C.closeForms()});$(this.cancelButton).keydown({obj:this},function(B){if(B.keyCode===13||B.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.bookend).keyup({obj:this},function(B){if(B.keyCode===9){var C=B.data.obj;C.closeForms()}})};ThemeManager.prototype=Object.create(Content.prototype);ThemeManager.prototype.constructor=ThemeManager;ThemeManager.prototype.setThemeNumber=function(a){this.currentTheme=a;this.changeCaptions();this.closeForms()};ThemeManager.prototype.updateTheme=function(j,g,h,e,c,b,d,a,k,f){j=j-1;if(j>-1&&j<this.themes.length){this.themes[j]={metric:g,startYear:Number(h),endYear:Number(e),years:[],commodities:c,causes:b,commodityLookup:d,causeLookup:a,reportingUnit:k,measure:f}}};ThemeManager.prototype.getActiveTheme=function(){var a=null;if(this.currentTheme>0&&this.currentTheme<=this.themes.length){a=this.themes[this.currentTheme-1]}return a};ThemeManager.prototype.getTheme=function(b){var a=null;if(b>0&&b<this.themes.length+1){a=this.themes[b-1]}return a};ThemeManager.prototype.showForms=function(b){if(this.currentTheme>0&&this.currentTheme<3){$(this.contentContainer).removeClass(this.scrollableClass);var a=$(this.form).eq(this.currentTheme-1);var d=a.find(this.section);var e=$(this.sectionTab);var c=d.eq(b);e.addClass(this.truncatedClass);$(this.section).hide();c.show();$(this.formContainer).show();c.find("ul:first").focus()}};ThemeManager.prototype.closeForms=function(){$(this.contentContainer).addClass(this.scrollableClass);$(this.sectionTab+".active:first").focus();$(this.sectionTab).removeClass("active");$(this.section).hide();$(this.formContainer).hide();$(this.sectionTab).removeClass(this.truncatedClass)};ThemeManager.prototype.scrollToTop=function(){$(this.contentContainer).scrollTop(0)};ThemeManager.prototype.selectOptionsByValue=function(a,b){if(a){a.each(function(){if($(this).attr("value")==b){$(this).addClass("selected")}})}};ThemeManager.prototype.unSelectOptionsByValue=function(a,b){if(a){a.each(function(){if($(this).attr("value")==b){$(this).removeClass("selected")}})}};ThemeManager.prototype.getMetric=function(){var c="";var a=$(this.form).eq(this.currentTheme-1);if(a.length>0){var b=a.find(this.metricOption+".selected");if(b.length>0){c=b.eq(0).attr("value")}}return c};ThemeManager.prototype.getMetricLabel=function(){var c="";var a=$(this.form).eq(this.currentTheme-1);if(a.length>0){var b=a.find(this.metricOption+".selected");if(b.length>0){c=b.eq(0).text()}}return c};ThemeManager.prototype.getStartYear=function(){var e="";var b=$(this.form).eq(this.currentTheme-1);if(b.length>0){var a=b.find(this.yearOption+this.allOption+".selected");if(a.length>0){var c=b.find(this.yearOption).not(this.allOption);if(c.length>0){e=c.eq(0).attr("value")}}else{var d=b.find(this.yearOption+".selected");if(d.length>0){e=d.eq(0).attr("value")}}}return e};ThemeManager.prototype.getEndYear=function(){var e="";var b=$(this.form).eq(this.currentTheme-1);if(b.length>0){var a=b.find(this.yearOption+this.allOption+".selected");if(a.length>0){var c=b.find(this.yearOption).not(this.allOption);if(c.length>0){e=c.eq(c.length-1).attr("value")}}else{var d=b.find(this.yearOption+".selected");if(d.length>0){e=d.eq(d.length-1).attr("value")}}}return e};ThemeManager.prototype.getCommodities=function(){var a=[];var b=$(this.form).eq(this.currentTheme-1);var d;if(b.length>0){var c=b.find(this.commodityOption+".selected").not(this.allOption);c.each(function(){d=$(this).attr("value");if(a.indexOf(d)==-1){a.push(d)}})}return a.join("|")};ThemeManager.prototype.getCauses=function(){var a=[];var b=$(this.form).eq(this.currentTheme-1);var d;if(b.length>0){var c=b.find(this.causeOption+".selected").not(this.allOption);c.each(function(){d=$(this).attr("value");if(a.indexOf(d)==-1){a.push(d)}})}return a.join("|")};ThemeManager.prototype.getCommodityLookup=function(){var d={};var b=$(this.form).eq(this.currentTheme-1);var a,c;if(b.length>0){var e=b.find(this.commodityOption+".selected").not(this.allOption);if(e.length==0){e=b.find(this.commodityOption).not(this.allOption)}e.each(function(){a=$(this).attr("value");c=$(this).text();c=c.charAt(0).toUpperCase()+c.slice(1);if(a){if(!d.hasOwnProperty(a)){d[a]=c}}})}return d};ThemeManager.prototype.getCauseLookup=function(){var d={};var b=$(this.form).eq(this.currentTheme-1);var a,c;if(b.length>0){var e=b.find(this.causeOption+".selected").not(this.allOption);if(e.length==0){e=b.find(this.causeOption).not(this.allOption)}e.each(function(){a=$(this).attr("value");c=$(this).text();c=c.charAt(0).toUpperCase()+c.slice(1);if(a){if(!d.hasOwnProperty(a)){d[a]=c}}})}return d};ThemeManager.prototype.getReportingUnit=function(){var b="county";var a=$(this.form).eq(this.currentTheme-1);if(a.length>0){b=a.find(this.reportingUnitMenu).val()}return b};ThemeManager.prototype.getMeasurementUnit=function(){var b="";var a=$(this.form).eq(this.currentTheme-1);if(a.length>0){b=a.find(this.measurementUnitMenu).val()}return b};ThemeManager.prototype.fetchMapData=function(){var a=this.controller;if(a){var m=this.controller.map;var e=this.controller.chartManager;var h=$(this.form).eq(this.currentTheme-1);if(m&&h){a.startLoadAnimation();var l=this;var o=this.getMetric();var r=this.getStartYear();var j=this.getEndYear();var f=this.getCommodities();var d=this.getCauses();var g=this.getCommodityLookup();var b=this.getCauseLookup();var t=this.getReportingUnit();var n=this.getMeasurementUnit();var p=this.getMetricLabel();if(o=="payment_acreage"&&r<2001){r=2001}var s=r;if(r!=j){s=r+"&ndash;"+j}this.thematicData=null;var q={metric:o,startYear:r,endYear:j,commodities:f,causes:d,measurementUnit:n,reportingUnit:t};var k=false;if(n=="per_mile"){p=p+" (per sq mile)";k=true}else{if(n=="per_km"){p=p+" (per sq km)";k=true}}$.get("payment-map-data.php",q,function(u){if(u!=""){try{l.thematicData=JSON.parse(u);var w=h.find(l.classMethodMenu).val();var c=h.find(l.classCountMenu).val();l.updateCaptions(p,s,f,d,w,c,g,b);l.updateTheme(l.currentTheme,o,r,j,f,d,g,b,t,n);m.updateTheme(l.currentTheme,p,l.thematicData,w,c,t,n,k)}catch(v){a.stopLoadAnimation();alert("There was an error loading data")}}else{a.stopLoadAnimation()}})}}};ThemeManager.prototype.updateYears=function(c){if(c.length>0){var f=c.find(this.yearOption);var b=c.find(this.yearOption+".active");var a=b.length;var e;f.removeClass("selection");selectionOn=false;activeIndex=0;for(var d=0;d<f.length;d++){e=f.eq(d);if(e.hasClass("active")){activeIndex++;e.addClass("selected");if(selectionOn){if(activeIndex==a){selectionOn=false}}else{this.startYear=e.attr("value");if(a>1){selectionOn=true}}}else{if(selectionOn){e.addClass("selected")}}}}};ThemeManager.prototype.updateCaptions=function(l,o,e,d,k,j,h,c){var g=e.split("|");var b=d.split("|");var f="All commodities";var a="All causes";var m=j+" classes, "+k;if(e!=""&&g.length==1){f=h[g[0]]}else{if(g.length>1){f="Multiple commodities"}}if(d!=""&&b.length==1){a=c[b[0]]}else{if(b.length>1){a="Multiple causes"}}if(this.currentTheme>0&&this.currentTheme<3){var n=this.themeCaptions[this.currentTheme-1];n.metric=l;n.dates=o;n.commodity=f;n.cause=a;n.settings=m;this.changeCaptions()}};ThemeManager.prototype.changeCaptions=function(){if(this.currentTheme>0&&this.currentTheme<3){var a=this.themeCaptions[this.currentTheme-1];$(this.metricCaption).html(a.metric);$(this.yearCaption).html(a.dates);$(this.commodityCaption).html(a.commodity);$(this.causeCaption).html(a.cause);$(this.settingsCaption).html(a.settings)}};var ChartManager=function(r,h,w,t,l,d,v,b,p,o,x,k,c,j,m,s,q,u,a,n,g,e,f){this.page=r;this.container=h;this.timeOption=w;this.section=t;this.metricTitle=l;this.chartContainer=d;this.seriesChart=v;this.barChart=b;this.monthlyInteractiveChart=p;this.monthlyChart=o;this.variableLabel=x;this.exportButton=k;this.bar=c;this.dot=j;this.monthlyBar=m;this.previousButton=s;this.nextButton=q;this.seriesChartClearButton=u;this.barChartClearButton=a;this.monthlyChartClearButton=n;this.chartPopup=g;this.chartPopupCanvas=e;this.chartPopupCloseButton=f;this.activeTheme=null;this.sectionDetails=[];this.addSectionDetails("annual","commodity","commodityLookup","by commodity","All commodities","blue");this.addSectionDetails("monthly","commodity","commodityLookup","by commodity","All commodities","blue");this.addSectionDetails("annual","cause","causeLookup","by cause of loss","All causes of loss","teal");this.addSectionDetails("monthly","cause","causeLookup","by cause of loss","All causes of loss","teal");$(this.timeOption).click({obj:this},function(A){var B=A.data.obj;var z=$(this).parents(B.container);var y=$(this).attr("value");z.find(B.timeOption).removeClass("checked");$(this).addClass("checked");B.toggleSections(z,y)});$(this.timeOption).keydown({obj:this},function(y){if(y.keyCode===13||y.keyCode===32){$(this).trigger("click")}});$(this.exportButton).click({obj:this},function(A){var B=A.data.obj;if(B.activeTheme){var z=$(this).parents(B.chartContainer);var y=z.find("svg");B.showChartPopup(y)}});$(this.exportButton).keydown({obj:this},function(y){if(y.keyCode===13||y.keyCode===32){$(this).trigger("click")}});$("body").on("click",this.barChart+" "+this.bar+".non-zero",{obj:this},function(E){var G=E.data.obj;var F=$(this).text();var H=$(this).parents(G.barChart);var I=H.parents(G.section);var D=I.parents(G.container);var B=D.find(G.section).index(I);var z=H.find(G.bar);var y=$(this).attr("class").replace("active","").trim();if($(this).attr("class")==y+" active"){var A;z.each(function(){A=$(this).attr("class").replace("active","").trim();$(this).attr("class",A)});G.updateSeriesChart(I,B,"","",false);G.updateMonthlyInteractiveChart(I,B,"","",false)}else{var C=$(this).attr("code");var A;z.each(function(){A=$(this).attr("class").replace("active","").trim();$(this).attr("class",A)});$(this).attr("class",y+" active");G.updateSeriesChart(I,B,C,F,false);G.updateMonthlyInteractiveChart(I,B,C,F,false)}});$("body").on("click",this.barChartClearButton,{obj:this},function(C){var D=C.data.obj;var F=$(this).parents(D.section);var E=F.find(D.barChart);var B=F.parents(D.container);var A=B.find(D.section).index(F);var y=E.find(D.bar);if(y.length>0){var z;y.each(function(){z=$(this).attr("class").replace("active","").trim();$(this).attr("class",z)});D.updateSeriesChart(F,A,"","",false);D.updateMonthlyInteractiveChart(F,A,"","",false)}});$("body").on("keydown",this.barChartClearButton,{obj:this},function(y){if(y.keyCode===13||y.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$("body").on("click",this.dot,{obj:this},function(C){var E=C.data.obj;if(E.activeTheme){var F=$(this).parents(E.seriesChart);var G=F.parents(E.section);var z=G.parents(E.container);var B=F.find(E.dot);var y=z.find(E.section).index(G);var A=$(this).attr("class").replace("active","").trim();if($(this).attr("class")==A+" active"){B.attr("class",A);E.updateBarChart(G,y,-1);E.updateMonthlyChart(G,y,-1)}else{B.attr("class",A);var D=B.index($(this));$(this).attr("class",A+" active");E.updateBarChart(G,y,D);E.updateMonthlyChart(G,y,D)}}});$(this.previousButton).click({obj:this},function(y){var z=y.data.obj;if(z.activeTheme){var A=$(this).parents(z.section);z.traverseTimeSeriesBackward(A)}});$(this.previousButton).keydown({obj:this},function(y){if(y.keyCode===13||y.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.nextButton).click({obj:this},function(y){var z=y.data.obj;if(z.activeTheme){var A=$(this).parents(z.section);z.traverseTimeSeriesForward(A)}});$(this.nextButton).keydown({obj:this},function(y){if(y.keyCode===13||y.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$("body").on("click",this.seriesChartClearButton,{obj:this},function(C){var D=C.data.obj;var F=$(this).parents(D.section);var E=F.find(D.seriesChart);var A=F.parents(D.container);var z=A.find(D.section).index(F);var B=E.find(D.dot);if(B.length>0){var y=B.eq(0).attr("class").replace("active","").trim();B.attr("class",y);D.updateBarChart(F,z,-1);D.updateMonthlyChart(F,z,-1)}});$("body").on("keydown",this.seriesChartClearButton,{obj:this},function(y){if(y.keyCode===13||y.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$("body").on("click",this.monthlyInteractiveChart+" "+this.monthlyBar,{obj:this},function(C){var E=C.data.obj;if(E.activeTheme){var F=$(this).parents(E.monthlyInteractiveChart);var G=F.parents(E.section);var B=G.parents(E.container);var A=B.find(E.section).index(G);var z=F.find(E.monthlyBar);var y=$(this).attr("class").replace("active","").trim();if($(this).attr("class")==y+" active"){z.attr("class",y);E.updateBarChart(G,A,-1)}else{z.attr("class",y);var D=z.index($(this));$(this).attr("class",y+" active");E.updateBarChart(G,A,D)}}});$("body").on("click",this.monthlyChartClearButton,{obj:this},function(C){var D=C.data.obj;var F=$(this).parents(D.section);var E=F.find(D.monthlyInteractiveChart);var B=F.parents(D.container);var A=B.find(D.section).index(F);var y=E.find(D.monthlyBar);if(y.length>0){var z=y.eq(0).attr("class").replace("active","").trim();y.attr("class",z);D.updateBarChart(F,A,-1)}});$("body").on("keydown",this.monthlyChartClearButton,{obj:this},function(y){if(y.keyCode===13||y.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.chartPopupCloseButton).click({obj:this},function(y){var z=y.data.obj;$(z.chartPopup).removeClass("active")});$(this.chartPopupCloseButton).keydown({obj:this},function(y){if(y.keyCode===13||y.keyCode===32){var z=y.data.obj;$(z.chartPopup).removeClass("active")}else{if(y.keyCode===9){y.preventDefault()}}});$(this.chartPopupCloseButton).keyup({obj:this},function(y){if(y.keyCode===9){y.preventDefault()}})};ChartManager.prototype=Object.create(Content.prototype);ChartManager.prototype.constructor=ChartManager;ChartManager.prototype.addSectionDetails=function(f,e,d,g,a,b){var c={timeVariable:f,groupVariable:e,groupLookup:d,titleLabel:g,chartLabel:a,color:b};this.sectionDetails.push(c)};ChartManager.prototype.toggleSections=function(b,a){if(this.activeTheme&&b.length>0){var e=b.find(this.section);var d=this.sectionDetails.length;if(e.length==d){e.removeClass("active");for(var c=0;c<d;c++){if(this.sectionDetails[c].timeVariable==a){e.eq(c).addClass("active")}}}}};ChartManager.prototype.fetchChartData=function(h,g,f){var b=this.controller;if(b.themeManager){var a=b.themeManager.getTheme(h);var d=this;if(a){if(a.hasOwnProperty("metric")){b.startLoadAnimation();var e={metric:a.metric,startYear:a.startYear,endYear:a.endYear,commodities:a.commodities,causes:a.causes,measurementUnit:a.measure,reportingUnit:a.reportingUnit,reportingUnitList:g.join("|")};$.get("payment-chart-data.php",e,function(c){if(c!=""){try{var j=JSON.parse(c);$(d.page).show();d.loadCharts(h,f,j)}catch(k){b.stopLoadAnimation();alert("There was an error loading data")}}else{b.stopLoadAnimation()}})}else{$(d.page).show()}}else{$(d.page).show()}}};ChartManager.prototype.loadCharts=function(q,o,f){if(this.controller.themeManager){var a=this.controller.themeManager.getTheme(q);var e=$(this.container);if(a&&q<=e.length){var d=e.eq(q-1);var r=a.startYear;this.activeTheme=a;a.data=f;a.years=[];metricLabel=a.metric.replace("_"," ");if(a.startYear!=a.endYear){r=a.startYear+"–"+a.endYear}r=r+" totals";if(o==""){if(a.reportingUnit=="state"){o="All states"}else{if(a.reportingUnit=="county"){o="All counties"}}}if(a.measure=="per_mile"){metricLabel=metricLabel+" (per sq mile)";isFloat=true}else{if(a.measure=="per_km"){metricLabel=metricLabel+" (per sq km)";isFloat=true}}for(var h=a.startYear;h<a.endYear+1;h++){a.years.push(h)}d.addClass("loaded").addClass("active");var n=d.find(this.section);var m=n.length;var j=r;var l,g,p,k,b,c;if(m>0&&m==this.sectionDetails.length){for(var h=0;h<m;h++){l=n.eq(h);g=this.sectionDetails[h];l.find(this.metricTitle).html(metricLabel+" "+g.titleLabel);this.updateSeriesChart(l,h,"","",true);this.updateBarChart(l,h,-1);this.updateMonthlyInteractiveChart(l,h,"","",true);this.updateMonthlyChart(l,h,-1)}}this.controller.stopLoadAnimation()}}};ChartManager.prototype.updateSeriesChart=function(g,e,b,o,n){if(g.length>0&&e<this.sectionDetails.length&&this.activeTheme){var f=g.find(this.seriesChart);if(this.activeTheme.data&&this.activeTheme.years&&f.length>0){var h=this.activeTheme.data;var k=this.sectionDetails[e];var p,d;var j="";if(h.hasOwnProperty(k.timeVariable)){p=h[k.timeVariable];if(p.hasOwnProperty(k.groupVariable)){d=p[k.groupVariable]}}if(d){var m=-1;if(!n){var l=f.find(this.dot);var a=f.find(this.dot+".active");if(a.length>0){m=l.index(a.eq(0))}}var c=f.get()[0];f.empty();if(b==""){this.createTimeSeriesChart(c,d.total,this.activeTheme.years,m,k.chartLabel,k.color)}else{if(d.hasOwnProperty(b)){this.createTimeSeriesChart(c,d[b],this.activeTheme.years,m,o,k.color)}}}}}};ChartManager.prototype.updateBarChart=function(f,c,j){if(f.length>0&&this.activeTheme){var e=f.find(this.barChart);if(this.activeTheme.data&&this.activeTheme.years&&e.length>0){var g=this.activeTheme.data;var h=this.sectionDetails[c];var m,l,b;var d="";if(h.timeVariable=="monthly"){if(j>-1&&j<12){var k=["January","February","March","April","May","June","July","August","September","October","November","December"];d=k[j]}else{d="Annual"}}else{if(j>-1){d=this.activeTheme.years[j]}else{if(this.activeTheme.startYear==this.activeTheme.endYear){d=this.activeTheme.startYear}else{d=this.activeTheme.startYear+"–"+this.activeTheme.endYear}}}d=d+" totals "+h.titleLabel;if(g.hasOwnProperty(h.timeVariable)&&this.activeTheme.hasOwnProperty(h.groupLookup)){m=g[h.timeVariable];l=this.activeTheme[h.groupLookup];if(m.hasOwnProperty(h.groupVariable)){b=m[h.groupVariable]}}if(b){e.empty();var a=e.get()[0];this.createBarChart(a,b,l,j,d,h.color)}}}};ChartManager.prototype.updateMonthlyInteractiveChart=function(h,f,b,n,m){if(h.length>0&&this.activeTheme){var g=h.find(this.monthlyInteractiveChart);if(this.activeTheme.data&&g.length>0){var j=this.activeTheme.data;var k=this.sectionDetails[f];var o,e;if(j.hasOwnProperty(k.timeVariable)){o=j[k.timeVariable];if(o.hasOwnProperty(k.groupVariable)){e=o[k.groupVariable]}}if(e){var l=-1;if(!m){var c=g.find(this.monthlyBar);var a=g.find(this.monthlyBar+".active");if(a.length>0){l=c.index(a.eq(0))}}var d=g.get()[0];g.empty();if(b==""){this.createMonthlyBarChart(d,e,b,l,k.chartLabel+" by month",k.color)}else{if(e.hasOwnProperty(b)){this.createMonthlyBarChart(d,e,b,l,n+" by month",k.color)}}}}}};ChartManager.prototype.updateMonthlyChart=function(g,d,l){if(g.length>0&&this.activeTheme){var f=g.find(this.monthlyChart);var j=this.sectionDetails[d];if(this.activeTheme.data&&this.activeTheme.years&&f.length>0&&j.timeVariable=="annual"){var h=this.activeTheme.data;var k,c;var e="";if(l>-1){e=this.activeTheme.years[l]}else{if(this.activeTheme.startYear==this.activeTheme.endYear){e=this.activeTheme.startYear}else{e=this.activeTheme.startYear+"–"+this.activeTheme.endYear}}var e=e+" totals by month";var a=this.activeTheme.startYear+l;if(h.hasOwnProperty("monthly")){k=h.monthly;if(k.hasOwnProperty("year")){c=k.year}}if(c){f.empty();var b=f.get()[0];this.createMonthlyBarChart(b,c,a,-1,e,j.color)}}}};ChartManager.prototype.createTimeSeriesChart=function(a,d,G,F,w,b){var E=G.length;if(d.length!=E){return}function e(x,y){if(y==F){return"series-chart-dot "+b+" active"}else{return"series-chart-dot "+b}}function q(x,y){u.transition().duration(200).style("visibility","visible").style("opacity",1);u.html(G[y]+": "+d3.format(",")(Number(x))).style("left",(A(y)+h.left)+"px").style("top",(C(x/o)+h.top-40)+"px")}function g(x,y){u.transition().duration(200).style("visibility","hidden").style("opacity",0)}var t=290;var s=270;var l=d3.min(d,function(x){return Number(x)});var j=d3.max(d,function(x){return Number(x)});var o=1;var p="";var c=d3.format(",");if(j>=10000000000){o=1000000000;p="(x 1,000,000,000)"}else{if(j>=10000000){o=1000000;p="(x 1,000,000)"}else{if(j>=10000){o=1000;p="(x 1,000)"}}}j=j/o;l=l/o;var m=l-(j-l)*0.4;var k=j+(j-l)*0.4;var h={top:50,right:20,bottom:26,left:40},z=t-h.left-h.right,f=s-h.top-h.bottom;var C=d3.scaleLinear().domain([m,k]).range([f,0]);var D=d3.axisLeft().scale(C).ticks(5).tickSize(6).tickPadding(4);var A=d3.scaleLinear().domain([0,E]).range([0,z]);var v=d3.line().x(function(x,y){return A(y)}).y(function(x){return C(x/o)});var r=d3.select(a).append("svg").attr("width",t).attr("height",s).append("g").attr("transform","translate("+h.left+","+h.top+")");var B=d3.axisBottom().scale(A).ticks(5).tickFormat(function(x){return G[x]}).tickSize(6).tickPadding(4);var n=r.append("path").attr("d",v(d)).attr("stroke","#000").attr("stroke-width",2).attr("fill","none").attr("class","series-chart-path "+b);r.selectAll("dot").data(d).enter().append("circle").attr("r",7).attr("stroke-width",0).attr("cx",function(x,y){return A(y)}).attr("cy",function(x){return C(x/o)}).attr("class",e).on("mouseover",q).on("mouseout",g);var u=d3.select(a).append("div").attr("class","series-tooltip").style("opacity",0);r.append("g").attr("class","series-chart-axis x-axis").attr("transform","translate(0,"+f+")").call(B);r.append("g").attr("class","series-chart-axis y-axis").call(D);r.append("text").attr("font-family","Arial, sans-serif").attr("font-size","15px").attr("class",this.variableLabel.substring(1)).style("text-anchor","start").append("tspan").attr("y",0-h.top).attr("x",0-h.left).attr("dy","1em").text(w).append("tspan").attr("y",0-h.top).attr("x",0-h.left).attr("dy","2.1em").text(p)};ChartManager.prototype.createBarChart=function(e,h,s,Q,R,f){var I=[];var J=[];var b=0;var d=16;var c=4;var A=10;var H=0;var B=0;var g=d3.format(",");var r,F,t,K,u;for(var m in h){if(h.hasOwnProperty(m)){if(Q>-1&&Q<h[m].length){K=Number(h[m][Q])}else{K=d3.sum(h[m],function(x){return Number(x)})}r="";F="non-zero";if(s.hasOwnProperty(m)){r=s[m]}if(K==0){F="zero"}if(m!="total"){t={code:m,name:r,textClass:F,value:K};I.push(t);H=H+K;b++}}}I.sort(function(x,y){if(y.value==x.value){return x.name.localeCompare(y.name)}else{return y.value-x.value}});if(b<A){A=b}for(var l=0;l<A;l++){B=B+I[l].value;J.push(I[l])}u=H-B;F="non-zero";if(u==0){F="zero"}t={code:"other",name:"Other",textClass:F,value:u};J.push(t);function z(x,y){G.transition().duration(200).style("visibility","visible").style("opacity",1);G.html(d3.format(",")(x.value)).style("left",(n.left+10)+"px").style("top",(O(y)+n.top)+"px")}function k(x,y){G.transition().duration(200).style("visibility","hidden").style("opacity",0)}var q=d3.min(J,function(x){return x.value});var o=d3.max(J,function(x){return x.value});var v=1;var w="";if(o>=1000000000){v=1000000000;w="(x 1,000,000,000)"}else{if(o>=1000000){v=1000000;w="(x 1,000,000)"}else{if(o>=1000){v=1000;w="(x 1,000)"}}}o=o/v;q=q/v;var p=o+(o-q)*0.05;var E=290;var D=270;var n={top:50,right:10,bottom:0,left:180},L=E-n.left-n.right,j=(A+1)*(d+c);var M=d3.scaleLinear().domain([0,p]).range([0,L]);var O=d3.scaleLinear().domain([0,A+1.5]).range([0,j]);var C=d3.select(e).append("svg").attr("width",E).attr("height",D).append("g").attr("transform","translate("+n.left+","+n.top+")");var a=C.selectAll(".chart-bar").data(J).enter().append("g").attr("class","chart-bar "+f);var G=d3.select(e).append("div").attr("class","bar-tooltip").style("opacity",0);var N=d3.axisBottom().scale(M).ticks(3).tickSize(-6).tickPadding(-16);var P=d3.axisLeft().scale(O).ticks(A).tickFormat("").tickSize(0).tickPadding(0);C.append("g").attr("class","bar-chart-axis").call(N);C.append("g").attr("class","bar-chart-axis").call(P);a.append("rect").attr("x",0).attr("y",function(x,y){return O(y)+c*2}).attr("width",function(x){return M(x.value/v)}).attr("height",d);a.append("text").attr("font-family","Arial, sans-serif").attr("font-size","12px").attr("class",function(x){return x.textClass}).attr("dy","0.4em").attr("x",-4).attr("y",function(x,y){return O(y)+c*2+d/2}).attr("text-anchor","end").attr("code",function(x){return x.code}).text(function(x){return x.name}).on("mouseover",z).on("mouseout",k);C.append("text").attr("font-family","Arial, sans-serif").attr("font-size","15px").attr("class",this.variableLabel.substring(1)).attr("dy","1em").style("text-anchor","start").append("tspan").attr("y",0-n.top).attr("x",0-n.left).attr("dy","1em").text(R).append("tspan").attr("y",0-n.top).attr("x",0-n.left).attr("dy","2.1em").text(w)};ChartManager.prototype.createMonthlyBarChart=function(f,k,F,o,g,h){var p=["J","F","M","A","M","J","J","A","S","O","N","D"];var u=["January","February","March","April","May","June","July","August","September","October","November","December"];var E=[0,0,0,0,0,0,0,0,0,0,0,0];var b=12;var e=16;var d=4;var j=d3.format(",");if(F<0||!k.hasOwnProperty(F)){for(var n=0;n<12;n++){E[n]=Number(k.total[n])}}else{for(var n=0;n<12;n++){E[n]=Number(k[F][n])}}function c(x,y){if(y==o){return"chart-bar "+h+" active"}else{return"chart-bar "+h}}function z(x,y){D.transition().duration(200).style("visibility","visible").style("opacity",1);D.html(u[y]+": "+d3.format(",")(x)).style("left",(H(y)+q.left)+"px").style("top",(J(x/v)+q.top-20)+"px")}function m(x,y){D.transition().duration(200).style("visibility","hidden").style("opacity",0)}var C=290;var B=270;var t=d3.min(E);var r=d3.max(E);var v=1;var w="";if(r>=1000000000){v=1000000000;w="(x 1,000,000,000)"}else{if(r>=1000000){v=1000000;w="(x 1,000,000)"}else{if(r>=1000){v=1000;w="(x 1,000)"}}}r=r/v;t=t/v;var s=r+(r-t)*0.3;var q={top:50,right:20,bottom:26,left:40},G=C-q.left-q.right,l=B-q.top-q.bottom;var H=d3.scaleLinear().domain([-0.5,11.5]).range([0,G]);var J=d3.scaleLinear().domain([0,s]).range([l,0]);var A=d3.select(f).append("svg").attr("width",C).attr("height",B).append("g").attr("transform","translate("+q.left+","+q.top+")");var a=A.selectAll(".chart-bar").data(E).enter().append("g").attr("class",c);var D=d3.select(f).append("div").attr("class","series-tooltip").style("opacity",0);var I=d3.axisBottom().scale(H).ticks(12).tickFormat(function(x,y){return p[y]}).tickSize(6).tickPadding(4);var K=d3.axisLeft().scale(J).ticks(5).tickSize(6).tickPadding(4);A.append("g").attr("class","bar-chart-axis").attr("transform","translate(0,"+l+")").call(I);A.append("g").attr("class","bar-chart-axis").call(K);a.append("rect").attr("x",function(x,y){return H(y)-e/2}).attr("y",function(x){return J(x/v)}).attr("width",e).attr("height",function(x){return l-J(x/v)}).on("mouseover",z).on("mouseout",m);A.append("text").attr("font-family","Arial, sans-serif").attr("font-size","15px").attr("class",this.variableLabel.substring(1)).attr("dy","1em").style("text-anchor","start").append("tspan").attr("y",0-q.top).attr("x",0-q.left).attr("dy","1em").text(g).append("tspan").attr("y",0-q.top).attr("x",0-q.left).attr("dy","2.1em").text(w)};ChartManager.prototype.traverseTimeSeriesBackward=function(l){if(l.length>0){var g=l.parents(this.container);var f=g.find(this.section).index(l);if(f>-1&&f<this.sectionDetails.length){if(this.sectionDetails[f].timeVariable=="monthly"){var k=l.find(this.monthlyInteractiveChart);var d=k.find(this.monthlyBar);var a=k.find(this.monthlyBar+".active");var j=-1;if(d.length>0){var e=d.eq(0).attr("class").replace("active","");var b=e+" active";if(a.length>0){j=d.index(a.eq(0))}d.attr("class",e);j--;if(j<-1){j=11}if(j>-1){var a=d.eq(j);a.attr("class",b)}this.updateBarChart(l,f,j)}}else{var k=l.find(this.seriesChart);var h=k.find(this.dot);var c=k.find(this.dot+".active");var j=-1;if(h.length>0){var e=h.eq(0).attr("class").replace("active","");var b=e+" active";if(c.length>0){j=h.index(c.eq(0))}h.attr("class",e);j--;if(j<-1){j=this.activeTheme.years.length-1}if(j>-1){var c=h.eq(j);c.attr("class",b)}this.updateBarChart(l,f,j);this.updateMonthlyChart(l,f,j)}}}}};ChartManager.prototype.traverseTimeSeriesForward=function(l){if(l.length>0){var g=l.parents(this.container);var f=g.find(this.section).index(l);if(f>-1&&f<this.sectionDetails.length){if(this.sectionDetails[f].timeVariable=="monthly"){var k=l.find(this.monthlyInteractiveChart);var d=k.find(this.monthlyBar);var a=k.find(this.monthlyBar+".active");var j=-1;if(d.length>0){var e=d.eq(0).attr("class").replace("active","");var b=e+" active";if(a.length>0){j=d.index(a.eq(0))}d.attr("class",e);j++;if(j>11){j=-1}else{var a=d.eq(j);a.attr("class",b)}this.updateBarChart(l,f,j)}}else{var k=l.find(this.seriesChart);var h=k.find(this.dot);var c=k.find(this.dot+".active");var j=-1;if(h.length>0){var e=h.eq(0).attr("class").replace("active","");var b=e+" active";if(c.length>0){j=h.index(c.eq(0))}h.attr("class",e);j++;if(j>this.activeTheme.years.length-1){j=-1}else{var c=h.eq(j);c.attr("class",b)}this.updateBarChart(l,f,j);this.updateMonthlyChart(l,f,j)}}}}};ChartManager.prototype.showChartPopup=function(d){var e=$(this.chartPopup);var b=$(this.chartPopupCanvas);if(d.length>0&&e.length>0&&b.length>0){var c=b.get()[0];var a=function(){c.toDataURL()};this.chartToImage(d,c,a);e.addClass("active");$(this.chartPopupCloseButton).focus()}};ChartManager.prototype.chartToImage=function(c,b,a){if(c.length>0){var j=c.get()[0];var h=new XMLSerializer();var k=h.serializeToString(j);var g=new Image();var l=600;var e=579;var f=new Image(80,55);var d=b.getContext("2d");b.width=l;b.height=e;f.onload=function(){d.save();d.globalAlpha=0.1;d.drawImage(this,189,214,222,152);d.restore()};g.onload=function(){d.drawImage(this,0,0,l,e);a()};f.src="icons/USDA-logo.png";g.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(k)))}};var Tour=function(d,g,j,h,c,e,a,f,b){this.openButton=d;this.stopContainer=g;this.stopNumber=j;this.stopNarrative=h;this.nextStopButton=c;this.previousStopButton=e;this.closeButton=a;this.startBookEnd=f;this.endBookend=b;this.stops=[];this.currentStop=-1;$(this.openButton).click({obj:this},function(k){k.data.obj.show()});$(this.openButton).keydown({obj:this},function(k){if(k.keyCode===13||k.keyCode===32){k.data.obj.show()}});$(this.nextStopButton).click({obj:this},function(k){k.stopPropagation();k.data.obj.nextStop()});$(this.nextStopButton).keydown({obj:this},function(k){if(k.keyCode===13||k.keyCode===32){k.stopPropagation();k.data.obj.nextStop()}});$(this.previousStopButton).click({obj:this},function(k){k.stopPropagation();k.data.obj.previousStop()});$(this.previousStopButton).keydown({obj:this},function(k){if(k.keyCode===13||k.keyCode===32){k.stopPropagation();k.data.obj.previousStop()}});$(this.closeButton).click({obj:this},function(k){k.stopPropagation();k.data.obj.hide()});$(this.closeButton).keydown({obj:this},function(k){if(k.keyCode===13||k.keyCode===32){k.stopPropagation();var l=k.data.obj;l.hide();$(l.openButton).focus()}});$(this.startBookend).keyup({obj:this},function(k){if(k.keyCode===9){var l=k.data.obj;$(l.closeButton).focus()}});$(this.endBookend).keyup({obj:this},function(k){if(k.keyCode===9){var l=k.data.obj;$(l.previousStopButton).focus()}})};Tour.prototype.addStop=function(a,d,b,c){var e={anchorElement:a,narrative:d,enterAction:b,leaveAction:c};this.stops.push(e)};Tour.prototype.show=function(){var c=this.stops.length;var b;this.currentStop=-1;for(var a=0;a<c;a++){b=this.stops[a];$(b.anchorElement).show()}if(this.controller){this.controller.hideThemePanel()}this.nextStop()};Tour.prototype.hide=function(){var c=this.stops.length;var b;this.currentStop=-1;for(var a=0;a<c;a++){b=this.stops[a];$(b.anchorElement).hide()}$(this.stopNumber).empty();$(this.stopNarrative).empty();this.currentStop=-1};Tour.prototype.nextStop=function(){var a;if(this.currentStop>-1&&this.currentStop<this.stops.length){a=this.stops[this.currentStop];if(a.leaveAction){a.leaveAction()}}this.currentStop=this.currentStop+1;if(this.currentStop<0||this.currentStop>=this.stops.length){this.currentStop=0}var a=this.stops[this.currentStop];var b=$(this.stopContainer);$(this.stopNumber).html(this.currentStop+1);$(this.stopNarrative).html(a.narrative);$(a.anchorElement).append(b);if(a.enterAction){a.enterAction()}$(this.nextStopButton).focus()};Tour.prototype.previousStop=function(){var a;if(this.currentStop>-1&&this.currentStop<this.stops.length){a=this.stops[this.currentStop];if(a.leaveAction){a.leaveAction()}}this.currentStop=this.currentStop-1;if(this.currentStop<0||this.currentStop>=this.stops.length){this.currentStop=this.stops.length-1}a=this.stops[this.currentStop];var b=$(this.stopContainer);$(this.stopNumber).html(this.currentStop+1);$(this.stopNarrative).html(a.narrative);$(a.anchorElement).append(b);if(a.enterAction){a.enterAction()}$(this.previousStopButton).focus()};var UserSurvey=function(e,c,d,b,a){this.overlay=e;this.container=c;this.openButton=d;this.closeButton=b;this.bookend=a;$(this.openButton).click({obj:this},function(f){f.stopPropagation();var g=f.data.obj;$(g.overlay).addClass("active");$(g.closeButton).focus()});$(this.openButton).keydown({obj:this},function(f){if(f.keyCode===13||f.keyCode===32){f.stopPropagation();$(this).trigger("click")}});$(this.closeButton).click({obj:this},function(f){f.stopPropagation();var g=f.data.obj;$(g.overlay).removeClass("active");$(g.openButton).focus()});$(this.closeButton).keydown({obj:this},function(f){if(f.keyCode===13||f.keyCode===32){f.stopPropagation();$(this).trigger("click")}});$(this.bookend).keyup({obj:this},function(f){if(f.keyCode===9){var g=f.data.obj;$(g.overlay).removeClass("active");$(g.openButton).focus()}})};var DownloadManager=function(m,l,c,g,f,j,e,o,k,d,b,h,n,a){this.overlay=m;this.openButton=l;this.closeButton=c;this.detailsToggle=g;this.details=f;this.metricOption=j;this.countyOption=e;this.yearOption=o;this.monthOption=k;this.commodityOption=d;this.causeOption=b;this.formatMenu=h;this.submitButton=n;this.bookend=a;$(this.openButton).click({obj:this},function(p){p.stopPropagation();var q=p.data.obj;$(q.overlay).addClass("active");$(q.closeButton).focus();q.onOpen()});$(this.openButton).keydown({obj:this},function(p){if(p.keyCode===13||p.keyCode===32){p.stopPropagation();$(this).trigger("click")}});$(this.closeButton).click({obj:this},function(p){p.stopPropagation();var q=p.data.obj;$(q.overlay).removeClass("active");$(q.openButton).focus()});$(this.closeButton).keydown({obj:this},function(p){if(p.keyCode===13||p.keyCode===32){p.stopPropagation();$(this).trigger("click")}});$(this.detailsToggle).click({obj:this},function(p){var q=p.data.obj;$(this).toggleClass("active");$(q.details).toggle()});$(this.detailsToggle).keydown({obj:this},function(p){if(p.keyCode===13||p.keyCode===32){var q=p.data.obj;$(this).toggleClass("active");$(q.details).toggle()}});$(this.submitButton).click({obj:this},function(p){p.stopPropagation();var q=p.data.obj;$(q.overlay).removeClass("active");$(q.openButton).focus();q.requestData()});$(this.submitButton).keydown({obj:this},function(p){if(p.keyCode===13||p.keyCode===32){p.stopPropagation();$(this).trigger("click")}});$(this.bookend).keyup({obj:this},function(p){if(p.keyCode===9){var q=p.data.obj;$(q.overlay).removeClass("active");$(q.openButton).focus()}})};DownloadManager.prototype.onOpen=function(){var b=this.controller;if(b){if(b.themeManager){var a=b.themeManager.getActiveTheme();var d=b.map.getSelectedFeatureList();if(a){$(this.metricOption).each(function(){if($(this).val()==a.metric){$(this).prop("checked",true)}})}if(d==""){$(this.monthOption).prop("checked",false).prop("disabled",true);$(this.commodityOption).prop("checked",false).prop("disabled",true);$(this.causeOption).prop("checked",false).prop("disabled",true)}else{$(this.monthOption).prop("disabled",false);$(this.commodityOption).prop("disabled",false);$(this.causeOption).prop("disabled",false)}}}};DownloadManager.prototype.requestData=function(){var b=this.controller;if(b){if(b.map&&b.themeManager){var a=b.themeManager.getActiveTheme();if(a){var p=a.startYear;var j=a.endYear;var f=a.commodities;var e=a.causes;var k=a.measure;var q=a.reportingUnit;var o=b.map.getSelectedFeatureList();var r="";var l="";var h="no";var t="no";var m="no";var g="no";var d="no";if(o.length>0){r=o[0]}$(this.metricOption+":checked").each(function(){l=l+$(this).val()+"|"});if(l!=""){l=l.substring(0,l.length-1)}if($(this.countyOption).is(":checked")){h="yes"}if($(this.yearOption).is(":checked")){t="yes"}if($(this.monthOption).is(":checked")){m="yes"}if($(this.commodityOption).is(":checked")){g="yes"}if($(this.causeOption).is(":checked")){d="yes"}var n={metrics:l,startYear:p,endYear:j,commodities:f,causes:e,measurementUnit:k,reportingUnit:q,reportingUnitID:r,countyColumn:h,yearColumn:t,monthColumn:m,commodityColumn:g,causeColumn:d,format:$(this.formatMenu).val()};var s="payment-formatted-data.php?"+$.param(n);window.location.href=s}}}};var controller=new ContentController("#content","#header-menu","#header-links a","#header-links span","#load-overlay","#content-loader","#map-container","#theme-container","#theme-header","#theme-page","#chart-page","#theme-button","#chart-button","#theme-one-form","#theme-two-form","#theme-one-charts","#theme-two-charts");var rmaMap=new RMAMap("#map-container","#rma-map","#map-layer-one-option","#map-layer-two-option","#map-theme-metric",".selection-title h3","#map-legend",".map-legend-item",".map-legend-box",".map-legend-label","#map-popup","#map-resize-button","#search-container","#search-box-wrapper","#search-box","#search-button","#search-close-button");var themeManager=new ThemeManager("#theme-content","#theme-form-container",".theme-form",".theme-parameter",".theme-form-section","scrollable","truncated","#metric-details","#date-details","#commodity-details","#cause-details","#setting-details",".option-list",".metric-option-list li",".year-option-list li",".commodity-option-list li",".cause-option-list li",".all-option",".map-class-count-menu",".map-class-method-menu",".map-measurement-unit-menu",".reporting-unit-menu","#theme-form-clear-button","#theme-form-update-button","#theme-form-cancel-button",".theme-bookend");var chartManager=new ChartManager("#chart-page",".chart-section-container",".chart-time-option",".chart-section",".chart-title",".chart-wrapper",".series-chart",".bar-chart",".monthly-interactive-chart",".monthly-chart",".chart-variable-label",".chart-export-button",".chart-bar text",".series-chart-dot",".chart-bar",".series-chart-previous-button",".series-chart-next-button",".series-chart-clear-button",".bar-chart-clear-button",".monthly-chart-clear-button","#chart-overlay","#chart-popup-canvas","#chart-popup-close-button");var tour=new Tour("#tour-button","#tour-stop-container","#tour-stop-number","#tour-stop-narrative","#tour-next-stop-button","#tour-previous-stop-button","#tour-close-button","#tour-start-bookend","#tour-end-bookend");tour.addStop("#tour-layer-anchor","Toggle between two customizeable data layers by clicking on the Layer One or Layer Two option.",null,null);tour.addStop("#tour-map-anchor","Click on a county or state to view data specific to that map feature. Select multiple counties by holding down the Ctrl key, and select all counties by clicking on an area outside of U.S. boundaries.",null,null);tour.addStop("#tour-search-anchor","Search for and select a state or county by name.",null,null);tour.addStop("#tour-layer-details-anchor","Details about the selected data layer are shown on the Now Viewing panel. Modify data layer parameters (e.g., commodity) by clicking on the parameter name and choosing from available options.",function(){if(controller){$(controller.themeContainer).addClass("expanded")}},function(){if(controller){$(controller.themeContainer).removeClass("expanded")}});tour.addStop("#tour-selection-details-anchor","View additional details about the selected map feature by clicking on the View Selection Details (chart) icon. A panel containing several interactive charts will be displayed. Return to the Now Viewing panel by clicking on the View Layer Details (map) icon.",function(){if(controller){$(controller.themeContainer).addClass("expanded")}},function(){if(controller){$(controller.themeContainer).removeClass("expanded")}});tour.addStop("#tour-map-settings-anchor","Change how data is displayed on the map by clicking on the Map Settings option. For example, data can be reported by either state or county.",function(){if(controller){$(controller.themeContainer).addClass("expanded")}},function(){if(controller){$(controller.themeContainer).removeClass("expanded")}});var userSurvey=new UserSurvey("#survey-overlay","#survey-container-frame","#survey-button","#survey-close-button",".survey-bookend");var downloadManager=new DownloadManager("#download-overlay",".data-button","#download-close-button","#download-message-details-toggle","#download-message-details","#download-container input[name='metric']","#download-container input[name='county']","#download-container input[name='year']","#download-container input[name='month']","#download-container input[name='commodity']","#download-container input[name='cause']","#download-format-menu","#download-button",".download-bookend");controller.addThemeManager(themeManager);controller.addMap(rmaMap);controller.addChartManager(chartManager);controller.addTour(tour);controller.addUserSurvey(userSurvey);controller.addDownloadManager(downloadManager);controller.loadContent();var qs=decodeURI(location);var tourTag=qs.indexOf("#tour");if(tourTag>-1){tour.show()};