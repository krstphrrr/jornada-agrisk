var ContentController=function(c,h,f,g,j,d,e,l,m,n,b,k,a){this.content=c;this.menu=h;this.menuLink=f;this.menuOption=g;this.overlay=j;this.loader=d;this.mapContainer=e;this.themeContainer=l;this.themeHeader=m;this.themePage=n;this.chartPage=b;this.themeButton=k;this.chartButton=a;this.themeManager=null;this.map=null;this.chartManager=null;this.tour=null;this.userSurvey=null;this.downloadManager=null;this.chartView=false;$("body").click({obj:this},function(o){$(this).addClass("no-outline")});$("body").keydown({obj:this},function(o){if(o.keyCode===9){$(this).removeClass("no-outline")}});$(this.menuLink).focus({obj:this},function(p){var o=p.data.obj;$(o.menu).addClass("active")});$(this.menuLink).blur({obj:this},function(p){var o=p.data.obj;$(o.menu).removeClass("active")});$(this.menuOption).focus({obj:this},function(p){var o=p.data.obj;$(o.menu).addClass("active")});$(this.menuOption).blur({obj:this},function(p){var o=p.data.obj;$(o.menu).removeClass("active")});$(this.themeHeader).click({obj:this},function(p){var o=p.data.obj;o.toggleThemePanel()});$(this.themeHeader).keydown({obj:this},function(o){if(o.keyCode===13||o.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.themeButton).click({obj:this},function(p){var o=p.data.obj;o.chartView=false;$(o.chartPage).hide();$(o.themePage).show();$(o.chartButton).focus()});$(this.themeButton).keydown({obj:this},function(o){if(o.keyCode===13||o.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.chartButton).click({obj:this},function(p){var o=p.data.obj;o.chartView=true;$(o.themePage).hide();$(o.themeContainer).addClass("expanded");if(o.map){o.map.updateCharts()}});$(this.chartButton).keydown({obj:this},function(o){if(o.keyCode===13||o.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}})};ContentController.prototype.addThemeManager=function(a){this.themeManager=a;this.themeManager.controller=this};ContentController.prototype.addMap=function(a){this.map=a;this.map.controller=this};ContentController.prototype.addChartManager=function(a){this.chartManager=a;this.chartManager.controller=this};ContentController.prototype.addTour=function(a){this.tour=a;this.tour.controller=this};ContentController.prototype.addUserSurvey=function(a){this.userSurvey=a;this.userSurvey.controller=this};ContentController.prototype.addDownloadManager=function(a){this.downloadManager=a;this.downloadManager.controller=this};ContentController.prototype.loadContent=function(){if(this.map){this.map.loadMap()}};ContentController.prototype.startLoadAnimation=function(){$(this.overlay).removeClass("hidden");$(this.loader).html("<div class='loader-container'><p>Loading...</p><div class='loader'></div></div>")};ContentController.prototype.stopLoadAnimation=function(){$(this.overlay).addClass("hidden");$(this.loader).empty()};ContentController.prototype.resizeMap=function(a){if($(this.content).hasClass("more-map")){$(this.content).removeClass("more-map");a.text("More Map")}else{$(this.content).addClass("more-map");a.text("Less Map")}};ContentController.prototype.toggleThemePanel=function(){$(this.themeContainer).toggleClass("expanded");if(this.themeManager){this.themeManager.closeForms();this.themeManager.scrollToTop()}};ContentController.prototype.hideThemePanel=function(){$(this.themeContainer).removeClass("expanded");if(this.themeManager){this.themeManager.closeForms();this.themeManager.scrollToTop()}};ContentController.prototype.updateCharts=function(b,a){if(this.chartManager){if(this.chartView){this.chartManager.fetchChartData(b,a)}}};var Content=function(){this.controller=null};var RMAMap=function(a,h,b,p,r,q,f,d,c,e,j,g,l,k,m,n,o){this.container=a;this.map=h;this.countyOption=b;this.stateOption=p;this.themeTitle=r;this.themeCaption=q;this.legend=f;this.legendItem=d;this.legendBox=c;this.legendLabel=e;this.popupContainer=document.getElementById(j.substring(1));this.mapResizeButton=g;this.searchBoxContainer=l;this.searchBoxAnchor=k;this.searchBox=m;this.searchButton=n;this.searchCloseButton=o;this.olMap;this.polygonStroke;this.labelFill;this.selectStroke;this.selectStyle;this.styleFunction;this.basemap;this.overlay;this.featureOverlay;this.currentSelection="";this.currentSelectionName="";this.countySource;this.stateSource;this.themeLayer;this.stateList=[];this.countyList=[];this.activeTheme={loaded:false,name:"Not specified",data:[],digitCount:0,styleClasses:[],reportingUnit:"county",labelResolution:1000,measure:"actual"};this.mapLoaded=false;this.searchBoxReady=false;$(this.mapResizeButton).click({obj:this},function(s){var t=s.data.obj;if(t.controller){t.controller.resizeMap($(this))}if(t.olMap){t.olMap.updateSize()}});$(this.mapResizeButton).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){var t=s.data.obj;if(t.controller){t.controller.resizeMap($(this))}if(t.olMap){t.olMap.updateSize()}}});$(this.searchButton).click({obj:this},function(s){var t=s.data.obj;if(!t.searchBoxReady){t.initializeSearchBox()}$(t.searchBox).val("");$(t.searchBoxContainer).toggleClass("expanded")});$(this.searchButton).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.searchCloseButton).click({obj:this},function(s){var t=s.data.obj;$(t.searchButton).focus();$(t.searchBox).val("");$(t.searchBoxContainer).removeClass("expanded")});$(this.searchCloseButton).keydown({obj:this},function(s){if(s.keyCode===13||s.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.countyOption).click({obj:this},function(s){var t=s.data.obj;if(!$(this).hasClass("active")){if(t.controller&&t.controller.themeManager){t.controller.themeManager.fetchMapData("county");$(t.stateOption).removeClass("active");$(this).addClass("active")}}});$(this.countyOption).keydown({obj:this},function(s){if((s.keyCode===13||s.keyCode===32)){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.stateOption).click({obj:this},function(s){var t=s.data.obj;if(!$(this).hasClass("active")){if(t.controller&&t.controller.themeManager){t.controller.themeManager.fetchMapData("state");$(t.countyOption).removeClass("active");$(this).addClass("active")}}});$(this.stateOption).keydown({obj:this},function(s){if((s.keyCode===13||s.keyCode===32)){$(this).trigger("click");$("body").removeClass("no-outline")}})};RMAMap.prototype=Object.create(Content.prototype);RMAMap.prototype.constructor=RMAMap;RMAMap.prototype.loadContent=function(){this.loadMap()};RMAMap.prototype.loadMap=function(){var f=this;this.polygonStroke=new ol.style.Stroke({color:"#FFF",width:1});this.labelFill=new ol.style.Fill({color:"#000"});this.selectStroke=new ol.style.Stroke({color:"#000",width:3});this.selectStyle=new ol.style.Style({stroke:this.selectStroke});var j=new ol.style.Style({stroke:new ol.style.Stroke({color:"#222",width:1})});var g=new ol.style.Fill({color:"000"});this.styleFunction=(function(){return function(n,t){var q=false;if(t<f.activeTheme.labelResolution){q=true;var r=new ol.style.Style({text:new ol.style.Text({text:n.get("UNIT_NAME"),textAlign:"center",textBaseline:"middle",font:"normal 12px Arial, sans-serif",rotation:0,fill:f.labelFill})})}var u=f.activeTheme.data[n.get("UNIT_CODE")];var s=new ol.style.Style({stroke:f.polygonStroke});if(u){var l=f.activeTheme.styleClasses.length;for(var p=0;p<l;p++){if(u>=f.activeTheme.styleClasses[p].low&&(u<=f.activeTheme.styleClasses[p].high||Math.abs(u-f.activeTheme.styleClasses[p].high)<1e-10)){var m=f.activeTheme.styleClasses[p].color;var o=new ol.style.Fill({color:"rgb("+m.red+","+m.green+","+m.blue+")"});s=new ol.style.Style({stroke:f.polygonStroke,fill:o});break}}}if(q){return[s,r]}else{return[s]}}}());var a=new ol.Attribution({html:"Basemap provided by ESRI. Sources: Esri, HERE, DeLorme, MapmyIndia, © OpenStreetMap contributors, and the GIS user community. "});this.basemap=new ol.layer.Tile({id:"Gray",source:new ol.source.XYZ({attributions:[a],url:"https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}"})});a=new ol.Attribution({html:"State and county boundaries provided by the U.S. Census Bureau. "});var d=new ol.source.Vector({projection:"EPSG:3857",url:"data/cb_2015_us_county_20m.json",format:new ol.format.GeoJSON(),attributions:[a]});this.countySource=new ol.source.ImageVector({source:d,style:this.styleFunction});var k=new ol.source.Vector({projection:"EPSG:3857",url:"data/cb_2015_us_state_20m.json",format:new ol.format.GeoJSON(),attributions:[a]});this.stateSource=new ol.source.ImageVector({source:k,style:this.styleFunction});this.themeLayer=new ol.layer.Image({type:"county",source:this.countySource});var h=new ol.layer.Vector({type:"static",source:k,style:j});this.overlay=new ol.Overlay(({element:this.popupContainer,autoPan:false}));var b=ol.proj.transform([-98.5795,39.8283],"EPSG:4326","EPSG:3857");var c=ol.control.defaults({rotate:false});var e=ol.interaction.defaults({altShiftDragRotate:false,pinchRotate:false});this.olMap=new ol.Map({controls:c,interactions:e,layers:[this.basemap,this.themeLayer,h],overlays:[this.overlay],target:document.getElementById(this.map.substring(1)),view:new ol.View({center:b,zoom:4,minZoom:2})});this.featureOverlay=new ol.layer.Vector({source:new ol.source.Vector(),map:this.olMap,style:this.selectStyle});this.olMap.on("click",function(l){f.displayFeatureInfo(l.pixel,l.originalEvent.ctrlKey)});if(!this.mapLoaded){if(this.controller&&this.controller.themeManager){this.controller.themeManager.fetchMapData(this.activeTheme.reportingUnit)}}this.countySource.set("loadend",$(f.searchBoxContainer).show());this.countySource.set("loadend",this.mapLoaded=true)};RMAMap.prototype.displayFeatureInfo=function(d,a){var c=this;var b=this.olMap.forEachFeatureAtPixel(d,function(e,f){if(f){if(c.activeTheme.reportingUnit==f.get("type")){return e}}});this.selectFeature(b,!a,false)};RMAMap.prototype.resetSearchBox=function(){this.searchBoxReady=false;$(this.searchBox).val("");$(this.searchBoxContainer).removeClass("expanded")};RMAMap.prototype.onSearchSelection=function(b){var a=this.getFeatureByID(b);$(this.searchButton).focus();$(this.searchBox).blur();$(this.searchBox).val("");$(this.searchBoxContainer).removeClass("expanded");this.selectFeature(a,true,true)};RMAMap.prototype.getFeatureByID=function(e){var c=null;var b;if(this.activeTheme.reportingUnit=="county"&&this.countySource){c=this.countySource.getSource().getFeatures()}else{if(this.activeTheme.reportingUnit=="state"&&this.stateSource){c=this.stateSource.getSource().getFeatures()}}if(c){var a=c.length;for(var d=0;d<a;d++){b=c[d];if((b.get("UNIT_CODE"))==e){break}}}return b};RMAMap.prototype.updateCharts=function(){if(this.controller){var a=this.getSelectedFeatureList();this.controller.updateCharts(a,this.currentSelectionName)}};RMAMap.prototype.getSelectedFeatureList=function(){var b=this.featureOverlay.getSource().getFeatures();var a=b.length;var d=[];for(var c=0;c<a;c++){d.push(b[c].get("UNIT_CODE"))}return d};RMAMap.prototype.selectFeature=function(c,k,g){if(c){var l=false;var e=this.featureOverlay.getSource().getFeatures();var d=e.length;for(var f=0;f<d;f++){if(e[f]===c){l=true;break}}if(k){this.featureOverlay.getSource().clear()}else{if(l){this.featureOverlay.getSource().removeFeature(c)}}if(l){this.updateCaption()}else{this.featureOverlay.getSource().addFeature(c);this.updateCaption();if(g){var j=c.getGeometry();if(j){var b=j.getExtent();var a=[(b[0]+b[2])/2,(b[1]+b[3])/2];var m=this.olMap.getView();var h=ol.animation.pan({duration:1000,source:m.getCenter()});this.olMap.beforeRender(h);m.setCenter(a)}}}this.updateCharts()}else{this.clearSelections()}};RMAMap.prototype.clearSelections=function(a){this.featureOverlay.getSource().clear();this.currentSelection="";this.currentSelectionName="";this.updateCharts();this.updateCaption()};RMAMap.prototype.updateCaption=function(){var a=$(this.themeCaption);var c=this.featureOverlay.getSource().getFeatures();featureCount=c.length;if(featureCount>1){var j=0;var k,l,f;var e=0;var g;for(var d=0;d<featureCount;d++){id=c[d].get("UNIT_CODE");if(this.activeTheme.data[id]){k=Number(this.activeTheme.data[id]);j=j+k;l=String(k).split(".");if(l.length==2){f=l[1].length;if(d==0||f<e){e=f}}}}if(this.activeTheme.measure=="per_mile"||this.activeTheme.measure=="per_km"){j=j/featureCount}var g=Math.pow(10,e)/10;j=Math.round(j*g)/g;if(this.activeTheme.digitCount==0){var l=String(j).split(".");g=Math.pow(10,0);j=Math.floor(j*g)/g;var h="";if(l.length==2){if(Number(l[1])!=0){h="."+l[1]}}j=String(j).replace(/(.)(?=(\d{3})+$)/g,"$1,");j=j+h}this.currentSelection="";this.currentSelectionName="Multiple";a.html(this.currentSelectionName+": "+j)}else{if(featureCount==1){var b=c[0];this.currentSelection=b.get("UNIT_CODE");var k=this.activeTheme.data[this.currentSelection];if(this.activeTheme.reportingUnit=="county"){this.currentSelectionName=b.get("UNIT_NAME")+" County, "+b.get("STATE")}else{this.currentSelectionName=b.get("UNIT_NAME")}if(!k){k=0}else{var l=String(k).split(".");var g=Math.pow(10,0);k=Math.floor(k*g)/g;var h="";if(l.length==2){if(Number(l[1])!=0){h="."+l[1]}}k=String(k).replace(/(.)(?=(\d{3})+$)/g,"$1,");k=k+h}a.html(this.currentSelectionName+": "+k)}else{if(this.activeTheme.reportingUnit=="state"){a.html("All states")}else{a.html("All counties")}}}};RMAMap.prototype.updateTheme=function(j,h,e,b,f,d,c){var a=this.objectToArray(h);this.resetSearchBox();this.activeTheme.loaded=true;this.activeTheme.name=j;this.activeTheme.data=h;this.activeTheme.reportingUnit=f;this.activeTheme.measure=d;var g;$(this.themeTitle).html(j);if(f=="state"){this.activeTheme.labelResolution=4000;this.themeLayer.set("type","state");this.themeLayer.setSource(this.stateSource)}else{this.activeTheme.labelResolution=1000;this.themeLayer.set("type","county");this.themeLayer.setSource(this.countySource)}this.activeTheme.digitCount=0;if(c){this.activeTheme.digitCount=this.getDigitCount(a)}if(e=="equal interval"){g=this.getIntervalClasses(a,b)}else{if(e=="percentile"){g=this.getPercentileClasses(a,b)}else{if(e=="fixed interval"){g=this.getFixedClasses(a,b)}}}this.activeTheme.styleClasses=g;this.updateLegend(g,this.activeTheme.digitCount);this.clearSelections();this.refreshPolygonLayers();this.controller.stopLoadAnimation()};RMAMap.prototype.objectToArray=function(b){var a=[];for(var c in b){if(b.hasOwnProperty(c)){a.push(Number(b[c]))}}return a};RMAMap.prototype.updateLegend=function(n,c){var b=n.length;var k=$(this.legend);if(k.length>0){var f=k.find(this.legendItem);f.hide();if(b>0){var m=Math.pow(10,c+1)/10;var g,e,a,h,l,d;for(i=0;i<b;i++){g=b-1-i;e=f.eq(i);a=e.find(this.legendBox);h=e.find(this.legendLabel);color="rgb("+n[g].color.red+","+n[g].color.green+","+n[g].color.blue+")";l=n[g].low;d=n[g].high;l=Math.round(l*m)/m;d=Math.round(d*m)/m;if(c==0){l=String(l).replace(/(.)(?=(\d{3})+$)/g,"$1,");d=String(d).replace(/(.)(?=(\d{3})+$)/g,"$1,")}range=l+"&ndash;"+d;a.css("background-color",color);h.html(range);e.css("display","inline-block")}}}};RMAMap.prototype.getIntervalClasses=function(a,b){var m=[];if(a.length>0&&b>0&&b<11){a.sort(function(n,o){return n-o});var j=a[0];var h=a[a.length-1];var g=(h-j)/b;var d=j;var k,e,c,l;for(var f=0;f<b;f++){k=d+g;if(f==b-1){e=k}else{e=Number(k.toPrecision(3))}c=this.getColorClass(b,f+1);l={low:Number(d.toPrecision(3)),high:e,color:c};m.push(l);d=k}}return m};RMAMap.prototype.getPercentileClasses=function(a,b,d){var m=[];if(a.length>0&&b>0&&b<11){a.sort(function(n,o){return n-o});var h=100/b;var j=h;var e=a[0];var k,f,c,l;for(var g=0;g<b;g++){k=d3.quantile(a,j/100);if(g==b-1){f=k}else{f=Number(k.toPrecision(3))}c=this.getColorClass(b,g+1);l={low:Number(e.toPrecision(3)),high:f,color:c};m.push(l);e=k;j=j+h}}return m};RMAMap.prototype.getFixedClasses=function(a,d){var q=[];if(a.length>0&&d>0&&d<11){var r=[];for(var h=0;h<a.length;h++){if(a[h]>0){r.push(a[h])}}r.sort(function(s,t){return s-t});var l=0;var g=0;var k,f,e,p;var n=r[0];var m=r[r.length-1];var c=[9.999999999999999e-12,5e-11,1e-10,5e-10,1e-09,5e-09,1e-08,5e-08,1e-07,5e-07,1e-06,5e-06,1e-05,5e-05,0.0001,0.0005,0.001,0.005,0.01,0.05,0.1,0.5,1,5,10,50,100,500,1000,5000,10000,50000,100000,500000,1000000,5000000,10000000,50000000,100000000,500000000,1000000000,5000000000,10000000000,50000000000,100000000000,500000000000,1000000000000];for(h=0;h<c.length;h++){if(n<=c[h]){l=h;break}}for(h=0;h<c.length;h++){if(m<c[h]){g=h-1;break}}if(h==c.length){g=c.length-1}var j=g-l;var o=1;if(j<d){d=j+1}else{if(j>d*2){o=Math.floor(j/d)}}var b=g-d*o+o;for(h=0;h<d;h++){if(h==0){k=n}else{k=c[b+h*o]}if(h==d-1){f=m}else{f=c[b+h*o+o]}e=this.getColorClass(d,h+1);p={low:k,high:f,color:e};q.push(p)}}return q};RMAMap.prototype.percentile=function(d,c){var b=d.length;var e=(c/100)*(b-1)+1;var a=Math.floor(e);if(a>=b){result=d[b-1]}else{value1=d[a-1];value2=d[a];result=value1+e%1*(value2-value1)}return result};RMAMap.prototype.getDigitCount=function(a){var c=0;if(a.length>0){var g=[];for(var d=0;d<a.length;d++){if(a[d]>0){g.push(a[d])}}g.sort(function(h,j){return h-j});var f=g[0];var e=g[g.length-1];var b=e-f;if(b==0){c=0}else{if(b<1e-06){c=11}else{if(b<1e-05){c=10}else{if(b<0.0001){c=9}else{if(b<0.001){c=8}else{if(b<0.01){c=7}else{if(b<0.1){c=6}else{if(b<0){c=5}else{if(b<10){c=4}else{if(b<100){c=3}else{c=0}}}}}}}}}}}return c};RMAMap.prototype.getColorClass=function(a,e){var b={red:224,green:224,blue:224};if(e>0&&e<11){var f=1/a;var c=f/2;var h=e*f-c;var g={red:175,green:234,blue:212};var d={red:14,green:84,blue:57};b.red=Math.round(g.red+h*(d.red-g.red));b.green=Math.round(g.green+h*(d.green-g.green));b.blue=Math.round(g.blue+h*(d.blue-g.blue))}return b};RMAMap.prototype.refreshPolygonLayers=function(){this.olMap.getLayers().forEach(function(a){a.getSource().changed()})};RMAMap.prototype.initializeSearchBox=function(){var c=this;var a=$(this.searchBoxAnchor);var b=$(this.searchBox);b.val("");var d=[];if(this.activeTheme.reportingUnit=="state"){if(this.stateList.length==0){this.stateList=this.getStates()}d=this.stateList}else{if(this.countyList.length==0){this.countyList=this.getCounties()}d=this.countyList}$(this.searchBox).autocomplete({appendTo:a,source:d,minLength:4,delay:500,focus:function(e,f){return false},select:function(e,f){b.val(f.item.label);c.onSearchSelection(f.item.value);return false},open:function(e,m){var g=$(e.target);var k=g.autocomplete("widget");var l=k.position().top;var f=k.height();var h=g.height()*2;var j=l-f-h-4;k.css("top",j+"px")}});this.searchBoxReady=true};RMAMap.prototype.getCounties=function(){var b=[];var c;function a(d,e){if(d.state<e.state){return -1}if(d.state>e.state){return 1}if(d.label<e.label){return -1}if(d.label>e.label){return 1}return 0}if(this.countySource){this.countySource.getSource().forEachFeature(function(d){c={label:d.get("UNIT_NAME")+", "+d.get("STATE_NAME"),value:d.get("UNIT_CODE")};b.push(c)})}b=b.sort(a);return b};RMAMap.prototype.getStates=function(){var c=[];var b;function a(d,e){if(d.label<e.label){return -1}if(d.label>e.label){return 1}return 0}if(this.stateSource){this.stateSource.getSource().forEachFeature(function(d){b={label:d.get("UNIT_NAME"),value:d.get("UNIT_CODE")};c.push(b)})}c=c.sort(a);return c};var ThemeManager=function(l,m,n,u,t,s,w,p,y,j,d,v,r,q,z,k,e,a,f,g,o,h,x,c,b){this.contentContainer=l;this.formContainer=m;this.form=n;this.sectionTab=u;this.section=t;this.scrollableClass=s;this.truncatedClass=w;this.metricCaption=p;this.yearCaption=y;this.commodityCaption=j;this.causeCaption=d;this.settingsCaption=v;this.parameterList=r;this.metricOption=q;this.yearOption=z;this.commodityOption=k;this.causeOption=e;this.allOption=a;this.classCountMenu=f;this.classMethodMenu=g;this.measurementUnitMenu=o;this.clearButton=h;this.updateButton=x;this.cancelButton=c;this.bookend=b;this.thematicData=null;this.activeTheme=null;this.themeCaptions={metric:"",dates:"",commodity:"",cause:"",settings:""};$(this.classCountMenu).val(6);$(this.classMethodMenu).val("fixed interval");$(this.measurementUnitMenu).val("actual");$(this.sectionTab).click({obj:this},function(A){var C=A.data.obj;if(!$(this).hasClass("active")){var D=$(C.sectionTab);var B=D.index($(this));D.removeClass("active");$(this).addClass("active");C.showForms(B)}else{C.closeForms()}});$(this.sectionTab).keydown({obj:this},function(A){if(A.keyCode===13||A.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.parameterList).keydown({obj:this},function(A){if(A.keyCode===32){A.preventDefault();var B=A.data.obj;$(this).find("li").eq(0).focus()}});$(this.parameterList+" li").keydown({obj:this},function(A){if(A.keyCode===38){A.preventDefault();$(this).prev().focus()}});$(this.parameterList+" li").keydown({obj:this},function(A){if(A.keyCode===40){A.preventDefault();$(this).next().focus()}});$(this.metricOption).click({obj:this},function(A){var C=A.data.obj;if(!$(this).hasClass("selected")){var B=$(this).parents(C.form);var D=B.find(C.metricOption);D.removeClass("selected");$(this).addClass("selected")}});$(this.metricOption).keydown({obj:this},function(A){if(A.keyCode===13||A.keyCode===32){$(this).trigger("click")}});$(this.yearOption).click({obj:this},function(B){var D=B.data.obj;var C=$(this).parents(D.form);if($(this).hasClass(D.allOption.substring(1))){var E=C.find(D.yearOption);E.removeClass("active").removeClass("selected");$(this).addClass("selected")}else{if($(this).hasClass("selected")){var E=C.find(D.yearOption);var A=C.find(D.yearOption+D.allOption);E.removeClass("active").removeClass("selected");A.addClass("selected")}else{var A=C.find(D.yearOption+D.allOption);A.removeClass("selected");$(this).toggleClass("active");D.updateYears(C)}}});$(this.yearOption).keydown({obj:this},function(A){if(A.keyCode===13||A.keyCode===32){$(this).trigger("click")}});$(this.commodityOption).click({obj:this},function(B){var D=B.data.obj;var C=$(this).parents(D.form);var E=C.find(D.commodityOption);var G=$(this).attr("value");if($(this).hasClass("selected")){D.unSelectOptionsByValue(E,G);var F=C.find(D.commodityOption+".selected");if(F.length==0){var A=C.find(D.commodityOption+D.allOption);A.addClass("selected")}}else{if($(this).hasClass(D.allOption.substring(1))){E.removeClass("selected")}else{var A=C.find(D.commodityOption+D.allOption);A.removeClass("selected")}D.selectOptionsByValue(E,G)}});$(this.commodityOption).keydown({obj:this},function(A){if(A.keyCode===13||A.keyCode===32){$(this).trigger("click")}});$(this.causeOption).click({obj:this},function(B){var D=B.data.obj;var C=$(this).parents(D.form);var E=C.find(D.causeOption);var G=$(this).attr("value");if($(this).hasClass("selected")){D.unSelectOptionsByValue(E,G);var F=C.find(D.causeOption+".selected");if(F.length==0){var A=C.find(D.causeOption+D.allOption);A.addClass("selected")}}else{var C=$(this).parents(D.form);if($(this).hasClass(D.allOption.substring(1))){var E=C.find(D.causeOption);E.removeClass("selected")}else{var A=C.find(D.causeOption+D.allOption);A.removeClass("selected")}D.selectOptionsByValue(E,G)}});$(this.causeOption).keydown({obj:this},function(A){if(A.keyCode===13||A.keyCode===32){$(this).trigger("click")}});$(this.clearButton).click({obj:this},function(B){var E=B.data.obj;var C=$(E.form);if(C.length>0){var A=$(E.sectionTab+".active");var D=$(E.sectionTab).index(A);if(D>-1){var F=C.find(E.section).eq(D);if(F.length>0){F.find(E.yearOption).removeClass("active").removeClass("selected");F.find(E.commodityOption).removeClass("selected");F.find(E.causeOption).removeClass("selected");F.find(E.allOption).addClass("selected")}}}});$(this.clearButton).keydown({obj:this},function(A){if(A.keyCode===13||A.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.updateButton).click({obj:this},function(A){var B=A.data.obj;if(B.activeTheme){B.fetchMapData(B.activeTheme.reportingUnit);B.closeForms()}});$(this.updateButton).keydown({obj:this},function(A){if(A.keyCode===13||A.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.cancelButton).click({obj:this},function(A){var B=A.data.obj;B.closeForms()});$(this.cancelButton).keydown({obj:this},function(A){if(A.keyCode===13||A.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.bookend).keyup({obj:this},function(A){if(A.keyCode===9){var B=A.data.obj;B.closeForms()}})};ThemeManager.prototype=Object.create(Content.prototype);ThemeManager.prototype.constructor=ThemeManager;ThemeManager.prototype.getTheme=function(){return this.activeTheme};ThemeManager.prototype.updateTheme=function(g,h,e,c,b,d,a,j,f){this.activeTheme={metric:g,startYear:Number(h),endYear:Number(e),years:[],commodities:c,causes:b,commodityLookup:d,causeLookup:a,reportingUnit:j,measure:f}};ThemeManager.prototype.getActiveTheme=function(){return this.activeTheme};ThemeManager.prototype.showForms=function(b){$(this.contentContainer).removeClass(this.scrollableClass);var a=$(this.form);var d=a.find(this.section);var e=$(this.sectionTab);var c=d.eq(b);e.addClass(this.truncatedClass);$(this.section).hide();c.show();$(this.formContainer).show();c.find("ul:first").focus()};ThemeManager.prototype.closeForms=function(){$(this.contentContainer).addClass(this.scrollableClass);$(this.sectionTab+".active:first").focus();$(this.sectionTab).removeClass("active");$(this.section).hide();$(this.formContainer).hide();$(this.sectionTab).removeClass(this.truncatedClass)};ThemeManager.prototype.scrollToTop=function(){$(this.contentContainer).scrollTop(0)};ThemeManager.prototype.selectOptionsByValue=function(a,b){if(a){a.each(function(){if($(this).attr("value")==b){$(this).addClass("selected")}})}};ThemeManager.prototype.unSelectOptionsByValue=function(a,b){if(a){a.each(function(){if($(this).attr("value")==b){$(this).removeClass("selected")}})}};ThemeManager.prototype.getMetric=function(){var c="";var a=$(this.form);if(a.length>0){var b=a.find(this.metricOption+".selected");if(b.length>0){c=b.eq(0).attr("value")}}return c};ThemeManager.prototype.getMetricLabel=function(){var c="";var a=$(this.form);if(a.length>0){var b=a.find(this.metricOption+".selected");if(b.length>0){c=b.eq(0).text()}}return c};ThemeManager.prototype.getStartYear=function(){var e="";var b=$(this.form);if(b.length>0){var a=b.find(this.yearOption+this.allOption+".selected");if(a.length>0){var c=b.find(this.yearOption).not(this.allOption);if(c.length>0){e=c.eq(0).attr("value")}}else{var d=b.find(this.yearOption+".selected");if(d.length>0){e=d.eq(0).attr("value")}}}return e};ThemeManager.prototype.getEndYear=function(){var e="";var b=$(this.form);if(b.length>0){var a=b.find(this.yearOption+this.allOption+".selected");if(a.length>0){var c=b.find(this.yearOption).not(this.allOption);if(c.length>0){e=c.eq(c.length-1).attr("value")}}else{var d=b.find(this.yearOption+".selected");if(d.length>0){e=d.eq(d.length-1).attr("value")}}}return e};ThemeManager.prototype.getCommodities=function(){var a=[];var b=$(this.form);var d;if(b.length>0){var c=b.find(this.commodityOption+".selected").not(this.allOption);c.each(function(){d=$(this).attr("value");if(a.indexOf(d)==-1){a.push(d)}})}return a.join("|")};ThemeManager.prototype.getCauses=function(){var a=[];var b=$(this.form);var d;if(b.length>0){var c=b.find(this.causeOption+".selected").not(this.allOption);c.each(function(){d=$(this).attr("value");if(a.indexOf(d)==-1){a.push(d)}})}return a.join("|")};ThemeManager.prototype.getCommodityLookup=function(){var d={};var b=$(this.form);var a,c;if(b.length>0){var e=b.find(this.commodityOption+".selected").not(this.allOption);if(e.length==0){e=b.find(this.commodityOption).not(this.allOption)}e.each(function(){a=$(this).attr("value");c=$(this).text();c=c.charAt(0).toUpperCase()+c.slice(1);if(a){if(!d.hasOwnProperty(a)){d[a]=c}}})}return d};ThemeManager.prototype.getCauseLookup=function(){var d={};var b=$(this.form);var a,c;if(b.length>0){var e=b.find(this.causeOption+".selected").not(this.allOption);if(e.length==0){e=b.find(this.causeOption).not(this.allOption)}e.each(function(){a=$(this).attr("value");c=$(this).text();c=c.charAt(0).toUpperCase()+c.slice(1);if(a){if(!d.hasOwnProperty(a)){d[a]=c}}})}return d};ThemeManager.prototype.getMeasurementUnit=function(){var b="";var a=$(this.form);if(a.length>0){b=a.find(this.measurementUnitMenu).val()}return b};ThemeManager.prototype.fetchMapData=function(r){var a=this.controller;if(a){var m=this.controller.map;var e=this.controller.chartManager;var h=$(this.form);if(m&&h.length>0){a.startLoadAnimation();var l=this;var o=this.getMetric();var s=this.getStartYear();var j=this.getEndYear();var f=this.getCommodities();var d=this.getCauses();var g=this.getCommodityLookup();var b=this.getCauseLookup();var n=this.getMeasurementUnit();var p=this.getMetricLabel();if((o=="payment_acreage"||o=="liability"||o=="subsidy")&&s<2001){s=2001}var t=s;if(s!=j){t=s+"&ndash;"+j}this.thematicData=null;var q={metric:o,startYear:s,endYear:j,commodities:f,causes:d,measurementUnit:n,reportingUnit:r};var k=false;if(n=="per_mile"){p=p+" (per sq mile)";k=true}else{if(n=="per_km"){p=p+" (per sq km)";k=true}}$.get("payment-map-data.php",q,function(u){if(u!=""){try{l.thematicData=JSON.parse(u);var w=h.find(l.classMethodMenu).val();var c=h.find(l.classCountMenu).val();l.updateCaptions(p,t,f,d,w,c,g,b);l.updateTheme(o,s,j,f,d,g,b,r,n);m.updateTheme(p,l.thematicData,w,c,r,n,k)}catch(v){a.stopLoadAnimation();alert("There was an error loading data")}}else{a.stopLoadAnimation()}})}}};ThemeManager.prototype.updateYears=function(c){if(c.length>0){var f=c.find(this.yearOption);var b=c.find(this.yearOption+".active");var a=b.length;var e;f.removeClass("selection");selectionOn=false;activeIndex=0;for(var d=0;d<f.length;d++){e=f.eq(d);if(e.hasClass("active")){activeIndex++;e.addClass("selected");if(selectionOn){if(activeIndex==a){selectionOn=false}}else{this.startYear=e.attr("value");if(a>1){selectionOn=true}}}else{if(selectionOn){e.addClass("selected")}}}}};ThemeManager.prototype.updateCaptions=function(l,n,e,d,k,j,h,c){var g=e.split("|");var b=d.split("|");var f="All commodities";var a="All causes";var m=j+" classes, "+k;if(e!=""&&g.length==1){f=h[g[0]]}else{if(g.length>1){f="Multiple commodities"}}if(d!=""&&b.length==1){a=c[b[0]]}else{if(b.length>1){a="Multiple causes"}}this.themeCaptions.metric=l;this.themeCaptions.dates=n;this.themeCaptions.commodity=f;this.themeCaptions.cause=a;this.themeCaptions.settings=m;this.changeCaptions()};ThemeManager.prototype.changeCaptions=function(){$(this.metricCaption).html(this.themeCaptions.metric);$(this.yearCaption).html(this.themeCaptions.dates);$(this.commodityCaption).html(this.themeCaptions.commodity);$(this.causeCaption).html(this.themeCaptions.cause);$(this.settingsCaption).html(this.themeCaptions.settings)};var ChartManager=function(s,h,v,l,d,x,b,p,o,y,k,c,j,m,u,r,t,q,w,a,n,g,e,f){this.page=s;this.container=h;this.section=v;this.metricTitle=l;this.chartContainer=d;this.seriesChart=x;this.barChart=b;this.monthlyInteractiveChart=p;this.monthlyChart=o;this.variableLabel=y;this.exportButton=k;this.bar=c;this.dot=j;this.monthlyBar=m;this.previousYearButton=u;this.nextYearButton=r;this.previousMonthButton=t;this.nextMonthButton=q;this.seriesChartClearButton=w;this.barChartClearButton=a;this.monthlyChartClearButton=n;this.chartPopup=g;this.chartPopupCanvas=e;this.chartPopupCloseButton=f;this.activeTheme=null;this.sectionDetails=[];this.addSectionDetails("annual","commodity","commodityLookup","by commodity","all commodities","blue");this.addSectionDetails("annual","cause","causeLookup","by cause of loss","all causes of loss","teal");$(this.exportButton).click({obj:this},function(B){var C=B.data.obj;if(C.activeTheme){var A=$(this).parents(C.chartContainer);var z=A.find("svg");C.showChartPopup(z)}});$(this.exportButton).keydown({obj:this},function(z){if(z.keyCode===13||z.keyCode===32){$(this).trigger("click")}});$("body").on("click",this.barChart+" "+this.bar+".non-zero",{obj:this},function(F){var H=F.data.obj;var G=$(this).text();var I=$(this).parents(H.barChart);var J=I.parents(H.section);var E=J.parents(H.container);var C=E.find(H.section).index(J);var A=I.find(H.bar);var z=$(this).attr("class").replace("active","").trim();if($(this).attr("class")==z+" active"){var B;A.each(function(){B=$(this).attr("class").replace("active","").trim();$(this).attr("class",B)});H.updateSeriesChart(J,C,"bar","","",false);H.updateMonthlyInteractiveChart(J,C,"bar","","",false)}else{var D=$(this).attr("code");var B;A.each(function(){B=$(this).attr("class").replace("active","").trim();$(this).attr("class",B)});$(this).attr("class",z+" active");H.updateSeriesChart(J,C,"bar",D,G,false);H.updateMonthlyInteractiveChart(J,C,"bar",D,G,false)}});$("body").on("click",this.barChartClearButton,{obj:this},function(D){var E=D.data.obj;var G=$(this).parents(E.section);var F=G.find(E.barChart);var C=G.parents(E.container);var B=C.find(E.section).index(G);var z=F.find(E.bar);if(z.length>0){var A;z.each(function(){A=$(this).attr("class").replace("active","").trim();$(this).attr("class",A)});E.updateSeriesChart(G,B,"bar","","",false);E.updateMonthlyInteractiveChart(G,B,"bar","","",false)}});$("body").on("keydown",this.barChartClearButton,{obj:this},function(z){if(z.keyCode===13||z.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$("body").on("click",this.dot,{obj:this},function(D){var F=D.data.obj;if(F.activeTheme){var G=$(this).parents(F.seriesChart);var H=G.parents(F.section);var A=H.parents(F.container);var C=G.find(F.dot);var z=A.find(F.section).index(H);var B=$(this).attr("class").replace("active","").trim();if($(this).attr("class")==B+" active"){C.attr("class",B);F.updateBarChart(H,z,"annual",-1);F.updateMonthlyInteractiveChart(H,z,"annual","","",false)}else{C.attr("class",B);var E=C.index($(this));$(this).attr("class",B+" active");F.updateBarChart(H,z,"annual",E);F.updateMonthlyInteractiveChart(H,z,"annual",E,"",false)}}});$(this.previousYearButton).click({obj:this},function(z){var A=z.data.obj;if(A.activeTheme){var B=$(this).parents(A.section);A.traverseTimeSeriesBackward(B,"annual")}});$(this.previousYearButton).keydown({obj:this},function(z){if(z.keyCode===13||z.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.nextYearButton).click({obj:this},function(z){var A=z.data.obj;if(A.activeTheme){var B=$(this).parents(A.section);A.traverseTimeSeriesForward(B,"annual")}});$(this.nextYearButton).keydown({obj:this},function(z){if(z.keyCode===13||z.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$("body").on("click",this.seriesChartClearButton,{obj:this},function(D){var E=D.data.obj;var G=$(this).parents(E.section);var F=G.find(E.seriesChart);var B=G.parents(E.container);var A=B.find(E.section).index(G);var C=F.find(E.dot);if(C.length>0){var z=C.eq(0).attr("class").replace("active","").trim();C.attr("class",z);E.updateBarChart(G,A,"annual",-1);E.updateMonthlyInteractiveChart(G,A,"annual","","",false)}});$("body").on("keydown",this.seriesChartClearButton,{obj:this},function(z){if(z.keyCode===13||z.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$("body").on("click",this.monthlyInteractiveChart+" "+this.monthlyBar,{obj:this},function(D){var F=D.data.obj;if(F.activeTheme){var G=$(this).parents(F.monthlyInteractiveChart);var H=G.parents(F.section);var C=H.parents(F.container);var B=C.find(F.section).index(H);var A=G.find(F.monthlyBar);var z=$(this).attr("class").replace("active","").trim();if($(this).attr("class")==z+" active"){A.attr("class",z);F.updateSeriesChart(H,B,"monthly","","",false);F.updateBarChart(H,B,"monthly",-1)}else{A.attr("class",z);var E=A.index($(this));$(this).attr("class",z+" active");F.updateSeriesChart(H,B,"monthly",E,"",false);F.updateBarChart(H,B,"monthly",E)}}});$(this.previousMonthButton).click({obj:this},function(z){var A=z.data.obj;if(A.activeTheme){var B=$(this).parents(A.section);A.traverseTimeSeriesBackward(B,"monthly")}});$(this.previousMonthButton).keydown({obj:this},function(z){if(z.keyCode===13||z.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.nextMonthButton).click({obj:this},function(z){var A=z.data.obj;if(A.activeTheme){var B=$(this).parents(A.section);A.traverseTimeSeriesForward(B,"monthly")}});$(this.nextMonthButton).keydown({obj:this},function(z){if(z.keyCode===13||z.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$("body").on("click",this.monthlyChartClearButton,{obj:this},function(D){var E=D.data.obj;var G=$(this).parents(E.section);var F=G.find(E.monthlyInteractiveChart);var C=G.parents(E.container);var B=C.find(E.section).index(G);var z=F.find(E.monthlyBar);if(z.length>0){var A=z.eq(0).attr("class").replace("active","").trim();z.attr("class",A);E.updateSeriesChart(G,B,"monthly","","",false);E.updateBarChart(G,B,"",-1)}});$("body").on("keydown",this.monthlyChartClearButton,{obj:this},function(z){if(z.keyCode===13||z.keyCode===32){$(this).trigger("click");$("body").removeClass("no-outline")}});$(this.chartPopupCloseButton).click({obj:this},function(z){var A=z.data.obj;$(A.chartPopup).removeClass("active")});$(this.chartPopupCloseButton).keydown({obj:this},function(z){if(z.keyCode===13||z.keyCode===32){var A=z.data.obj;$(A.chartPopup).removeClass("active")}else{if(z.keyCode===9){z.preventDefault()}}});$(this.chartPopupCloseButton).keyup({obj:this},function(z){if(z.keyCode===9){z.preventDefault()}})};ChartManager.prototype=Object.create(Content.prototype);ChartManager.prototype.constructor=ChartManager;ChartManager.prototype.addSectionDetails=function(f,e,d,g,a,b){var c={timeVariable:f,groupVariable:e,groupLookup:d,titleLabel:g,chartLabel:a,color:b};this.sectionDetails.push(c)};ChartManager.prototype.fetchChartData=function(g,f){var b=this.controller;if(b.themeManager){var a=b.themeManager.getTheme();var d=this;if(a){if(a.hasOwnProperty("metric")){b.startLoadAnimation();var e={metric:a.metric,startYear:a.startYear,endYear:a.endYear,commodities:a.commodities,causes:a.causes,measurementUnit:a.measure,reportingUnit:a.reportingUnit,reportingUnitList:g.join("|")};$.get("payment-chart-data.php",e,function(c){if(c!=""){try{var h=JSON.parse(c);$(d.page).show();d.loadCharts(f,h)}catch(j){b.stopLoadAnimation();alert("There was an error loading data")}}else{b.stopLoadAnimation()}})}else{$(d.page).show()}}else{$(d.page).show()}}};ChartManager.prototype.loadCharts=function(m,e){if(this.controller.themeManager){var a=this.controller.themeManager.getTheme();var d=$(this.container);if(d.length>0){this.activeTheme=a;a.data=e;a.years=[];metricLabel=a.metric.replace("_"," ");if(m==""){if(a.reportingUnit=="state"){m="All states"}else{if(a.reportingUnit=="county"){m="All counties"}}}if(a.measure=="per_mile"){metricLabel=metricLabel+" (per sq mile)";isFloat=true}else{if(a.measure=="per_km"){metricLabel=metricLabel+" (per sq km)";isFloat=true}}for(var g=a.startYear;g<a.endYear+1;g++){a.years.push(g)}d.addClass("loaded").addClass("active");var l=d.find(this.section);var k=l.length;var j,f,n,h,b,c;if(k>0&&k==this.sectionDetails.length){for(var g=0;g<k;g++){j=l.eq(g);f=this.sectionDetails[g];j.find(this.metricTitle).html(metricLabel+" "+f.titleLabel);this.updateSeriesChart(j,g,"","","",true);this.updateBarChart(j,g,"",-1);this.updateMonthlyInteractiveChart(j,g,"","","",true)}}this.controller.stopLoadAnimation()}}};ChartManager.prototype.updateSeriesChart=function(g,d,o,p,e,m){if(g.length>0&&d<this.sectionDetails.length&&this.activeTheme){var f=g.find(this.seriesChart);if(this.activeTheme.data&&this.activeTheme.years&&f.length>0){var h=this.activeTheme.data;var j=this.sectionDetails[d];var q,c;if(o=="monthly"&&h.hasOwnProperty("monthly")&&p!=""&&p>-1&&p<12){q=h.monthly;if(q.hasOwnProperty("year")){q=q.year;c=[];for(var r in q){if(q.hasOwnProperty(r)){if(p<q[r].length){c.push(q[r][p])}}}}var n=["January","February","March","April","May","June","July","August","September","October","November","December"];e=n[p]+" totals, "+j.chartLabel}else{if(h.hasOwnProperty("annual")){q=h.annual;if(q.hasOwnProperty(j.groupVariable)){q=q[j.groupVariable];if(p==""){c=q.total;e="Annual totals, "+j.chartLabel}else{if(q.hasOwnProperty(p)){c=q[p];e="Annual "+e.toLowerCase()+" totals"}}}}}if(c){var l=-1;if(!m){var k=f.find(this.dot);var a=f.find(this.dot+".active");if(a.length>0){l=k.index(a.eq(0))}}var b=f.get()[0];f.empty();this.createTimeSeriesChart(b,c,this.activeTheme.years,l,e,j.color)}}}};ChartManager.prototype.updateBarChart=function(f,c,l,m){if(f.length>0&&this.activeTheme){var e=f.find(this.barChart);if(this.activeTheme.data&&this.activeTheme.years&&e.length>0){var g=this.activeTheme.data;var h=this.sectionDetails[c];var n,k,b;var d="";var o="";if(l==""){l="annual"}if(l=="annual"&&m>-1){o=this.activeTheme.years[m]}else{if(this.activeTheme.startYear==this.activeTheme.endYear){o=this.activeTheme.startYear}else{o=this.activeTheme.startYear+"–"+this.activeTheme.endYear}}if(l=="monthly"){if(this.activeTheme.startYear==this.activeTheme.endYear){o=this.activeTheme.startYear}else{o=this.activeTheme.startYear+"–"+this.activeTheme.endYear}if(m>-1&&m<12){var j=["January","February","March","April","May","June","July","August","September","October","November","December"];d=j[m]+" "+o+" totals "+h.titleLabel}else{d=o+" totals "+h.titleLabel}}else{d=o+" totals "+h.titleLabel}if(g.hasOwnProperty(l)&&this.activeTheme.hasOwnProperty(h.groupLookup)){n=g[l];k=this.activeTheme[h.groupLookup];if(n.hasOwnProperty(h.groupVariable)){b=n[h.groupVariable]}}if(b){e.empty();var a=e.get()[0];this.createBarChart(a,b,k,m,d,h.color)}}}};ChartManager.prototype.updateMonthlyInteractiveChart=function(h,e,n,o,f,m){if(h.length>0&&this.activeTheme){var g=h.find(this.monthlyInteractiveChart);if(this.activeTheme.data&&g.length>0){var j=this.activeTheme.data;var k=this.sectionDetails[e];var p,d;var q="";if(n==""){n="annual"}if(n=="annual"&&o!=""&&o>-1){q=this.activeTheme.years[o]}else{if(this.activeTheme.startYear==this.activeTheme.endYear){q=this.activeTheme.startYear}else{q=this.activeTheme.startYear+"–"+this.activeTheme.endYear}}if(j.hasOwnProperty("monthly")){p=j.monthly;if(n=="annual"&&p.hasOwnProperty("year")){d=p.year;if((o==""||o==-1)&&d.hasOwnProperty("total")){f=q+" monthly totals, "+k.chartLabel}else{o=this.activeTheme.startYear+o;f=o+" monthly totals, "+k.chartLabel}}else{if(p.hasOwnProperty(k.groupVariable)){d=p[k.groupVariable];if(o==""||o==-1){f=q+" monthly totals, "+k.chartLabel}else{f=q+" monthly "+f.toLowerCase()+" totals"}}}}if(d){var l=-1;if(!m){var b=g.find(this.monthlyBar);var a=g.find(this.monthlyBar+".active");if(a.length>0){l=b.index(a.eq(0))}}var c=g.get()[0];g.empty();this.createMonthlyBarChart(c,d,o,l,f,k.color)}}}};ChartManager.prototype.createTimeSeriesChart=function(a,e,G,F,b,c){var E=G.length;if(e.length!=E){return}function f(x,y){if(y==F){return"series-chart-dot "+c+" active"}else{return"series-chart-dot "+c}}function r(x,y){v.transition().duration(200).style("visibility","visible").style("opacity",1);v.html(G[y]+": "+d3.format(",")(Number(x))).style("left",(A(y)+j.left)+"px").style("top",(C(x/p)+j.top-40)+"px")}function h(x,y){v.transition().duration(200).style("visibility","hidden").style("opacity",0)}var u=290;var t=270;var m=d3.min(e,function(x){return Number(x)});var k=d3.max(e,function(x){return Number(x)});var p=1;var q="";var d=d3.format(",");if(k>=10000000000){p=1000000000;q="(x 1,000,000,000)"}else{if(k>=10000000){p=1000000;q="(x 1,000,000)"}else{if(k>=10000){p=1000;q="(x 1,000)"}}}k=k/p;m=m/p;var n=m-(k-m)*0.4;var l=k+(k-m)*0.4;var j={top:50,right:20,bottom:26,left:40},z=u-j.left-j.right,g=t-j.top-j.bottom;var C=d3.scaleLinear().domain([n,l]).range([g,0]);var D=d3.axisLeft().scale(C).ticks(5).tickSize(6).tickPadding(4);var A=d3.scaleLinear().domain([0,E]).range([0,z]);var w=d3.line().x(function(x,y){return A(y)}).y(function(x){return C(x/p)});var s=d3.select(a).append("svg").attr("width",u).attr("height",t).append("g").attr("transform","translate("+j.left+","+j.top+")");var B=d3.axisBottom().scale(A).ticks(5).tickFormat(function(x){return G[x]}).tickSize(6).tickPadding(4);var o=s.append("path").attr("d",w(e)).attr("stroke","#000").attr("stroke-width",2).attr("fill","none").attr("class","series-chart-path "+c);s.selectAll("dot").data(e).enter().append("circle").attr("r",7).attr("stroke-width",0).attr("cx",function(x,y){return A(y)}).attr("cy",function(x){return C(x/p)}).attr("class",f).on("mouseover",r).on("mouseout",h);var v=d3.select(a).append("div").attr("class","series-tooltip").style("opacity",0);s.append("g").attr("class","series-chart-axis x-axis").attr("transform","translate(0,"+g+")").call(B);s.append("g").attr("class","series-chart-axis y-axis").call(D);s.append("text").attr("font-family","Arial, sans-serif").attr("font-size","15px").attr("class",this.variableLabel.substring(1)).style("text-anchor","start").append("tspan").attr("y",0-j.top).attr("x",0-j.left).attr("dy","1em").text(b).append("tspan").attr("y",0-j.top).attr("x",0-j.left).attr("dy","2.1em").text(q)};ChartManager.prototype.createBarChart=function(e,j,u,k,f,g){var K=[];var L=[];var b=0;var d=16;var c=4;var C=10;var J=0;var D=0;var h=d3.format(",");var t,H,v,M,w;for(var o in j){if(j.hasOwnProperty(o)){if(k>-1&&k<j[o].length){M=Number(j[o][k])}else{M=d3.sum(j[o],function(x){return Number(x)})}t="";H="non-zero";if(u.hasOwnProperty(o)){t=u[o]}if(M==0){H="zero"}if(o!="total"){v={code:o,name:t,textClass:H,value:M};K.push(v);J=J+M;b++}}}K.sort(function(x,y){if(y.value==x.value){return x.name.localeCompare(y.name)}else{return y.value-x.value}});if(b<C){C=b}for(var n=0;n<C;n++){D=D+K[n].value;L.push(K[n])}w=J-D;H="non-zero";if(w==0){H="zero"}v={code:"other",name:"Other",textClass:H,value:w};L.push(v);function B(x,y){I.transition().duration(200).style("visibility","visible").style("opacity",1);I.html(d3.format(",")(x.value)).style("left",(p.left+10)+"px").style("top",(Q(y)+p.top)+"px")}function m(x,y){I.transition().duration(200).style("visibility","hidden").style("opacity",0)}var s=d3.min(L,function(x){return x.value});var q=d3.max(L,function(x){return x.value});var z=1;var A="";if(q>=1000000000){z=1000000000;A="(x 1,000,000,000)"}else{if(q>=1000000){z=1000000;A="(x 1,000,000)"}else{if(q>=1000){z=1000;A="(x 1,000)"}}}q=q/z;s=s/z;var r=q+(q-s)*0.05;var G=290;var F=270;var p={top:50,right:10,bottom:0,left:180},N=G-p.left-p.right,l=(C+1)*(d+c);var O=d3.scaleLinear().domain([0,r]).range([0,N]);var Q=d3.scaleLinear().domain([0,C+1.5]).range([0,l]);var E=d3.select(e).append("svg").attr("width",G).attr("height",F).append("g").attr("transform","translate("+p.left+","+p.top+")");var a=E.selectAll(".chart-bar").data(L).enter().append("g").attr("class","chart-bar "+g);var I=d3.select(e).append("div").attr("class","bar-tooltip").style("opacity",0);var P=d3.axisBottom().scale(O).ticks(3).tickSize(-6).tickPadding(-16);var R=d3.axisLeft().scale(Q).ticks(C).tickFormat("").tickSize(0).tickPadding(0);E.append("g").attr("class","bar-chart-axis").call(P);E.append("g").attr("class","bar-chart-axis").call(R);a.append("rect").attr("x",0).attr("y",function(x,y){return Q(y)+c*2}).attr("width",function(x){return O(x.value/z)}).attr("height",d);a.append("text").attr("font-family","Arial, sans-serif").attr("font-size","12px").attr("class",function(x){return x.textClass}).attr("dy","0.4em").attr("x",-4).attr("y",function(x,y){return Q(y)+c*2+d/2}).attr("text-anchor","end").attr("code",function(x){return x.code}).text(function(x){return x.name}).on("mouseover",B).on("mouseout",m);E.append("text").attr("font-family","Arial, sans-serif").attr("font-size","15px").attr("class",this.variableLabel.substring(1)).attr("dy","1em").style("text-anchor","start").append("tspan").attr("y",0-p.top).attr("x",0-p.left).attr("dy","1em").text(f).append("tspan").attr("y",0-p.top).attr("x",0-p.left).attr("dy","2.1em").text(A)};ChartManager.prototype.createMonthlyBarChart=function(f,k,F,o,g,h){var p=["J","F","M","A","M","J","J","A","S","O","N","D"];var u=["January","February","March","April","May","June","July","August","September","October","November","December"];var E=[0,0,0,0,0,0,0,0,0,0,0,0];var b=12;var e=16;var d=4;var j=d3.format(",");if(F==""||F<0||!k.hasOwnProperty(F)){for(var n=0;n<12;n++){E[n]=Number(k.total[n])}}else{for(var n=0;n<12;n++){E[n]=Number(k[F][n])}}function c(x,y){if(y==o){return"chart-bar "+h+" active"}else{return"chart-bar "+h}}function z(x,y){D.transition().duration(200).style("visibility","visible").style("opacity",1);D.html(u[y]+": "+d3.format(",")(x)).style("left",(H(y)+q.left)+"px").style("top",(J(x/v)+q.top-20)+"px")}function m(x,y){D.transition().duration(200).style("visibility","hidden").style("opacity",0)}var C=290;var B=270;var t=d3.min(E);var r=d3.max(E);var v=1;var w="";if(r>=1000000000){v=1000000000;w="(x 1,000,000,000)"}else{if(r>=1000000){v=1000000;w="(x 1,000,000)"}else{if(r>=1000){v=1000;w="(x 1,000)"}}}r=r/v;t=t/v;var s=r+(r-t)*0.3;var q={top:50,right:20,bottom:26,left:40},G=C-q.left-q.right,l=B-q.top-q.bottom;var H=d3.scaleLinear().domain([-0.5,11.5]).range([0,G]);var J=d3.scaleLinear().domain([0,s]).range([l,0]);var A=d3.select(f).append("svg").attr("width",C).attr("height",B).append("g").attr("transform","translate("+q.left+","+q.top+")");var a=A.selectAll(".chart-bar").data(E).enter().append("g").attr("class",c);var D=d3.select(f).append("div").attr("class","series-tooltip").style("opacity",0);var I=d3.axisBottom().scale(H).ticks(12).tickFormat(function(x,y){return p[y]}).tickSize(6).tickPadding(4);var K=d3.axisLeft().scale(J).ticks(5).tickSize(6).tickPadding(4);A.append("g").attr("class","bar-chart-axis").attr("transform","translate(0,"+l+")").call(I);A.append("g").attr("class","bar-chart-axis").call(K);a.append("rect").attr("x",function(x,y){return H(y)-e/2}).attr("y",function(x){return J(x/v)}).attr("width",e).attr("height",function(x){return l-J(x/v)}).on("mouseover",z).on("mouseout",m);A.append("text").attr("font-family","Arial, sans-serif").attr("font-size","15px").attr("class",this.variableLabel.substring(1)).attr("dy","1em").style("text-anchor","start").append("tspan").attr("y",0-q.top).attr("x",0-q.left).attr("dy","1em").text(g).append("tspan").attr("y",0-q.top).attr("x",0-q.left).attr("dy","2.1em").text(w)};ChartManager.prototype.traverseTimeSeriesBackward=function(l,m){if(l.length>0){var g=l.parents(this.container);var f=g.find(this.section).index(l);if(f>-1&&f<this.sectionDetails.length){if(m=="monthly"){var k=l.find(this.monthlyInteractiveChart);var d=k.find(this.monthlyBar);var a=k.find(this.monthlyBar+".active");var j=-1;if(d.length>0){var e=d.eq(0).attr("class").replace("active","");var b=e+" active";if(a.length>0){j=d.index(a.eq(0))}d.attr("class",e);j--;if(j<-1){j=11}if(j>-1){var a=d.eq(j);a.attr("class",b)}this.updateSeriesChart(l,f,"monthly",j,"",false);this.updateBarChart(l,f,"monthly",j)}}else{var k=l.find(this.seriesChart);var h=k.find(this.dot);var c=k.find(this.dot+".active");var j=-1;if(h.length>0){var e=h.eq(0).attr("class").replace("active","");var b=e+" active";if(c.length>0){j=h.index(c.eq(0))}h.attr("class",e);j--;if(j<-1){j=this.activeTheme.years.length-1}if(j>-1){var c=h.eq(j);c.attr("class",b)}this.updateBarChart(l,f,"annual",j);this.updateMonthlyInteractiveChart(l,f,"annual",j,"",false)}}}}};ChartManager.prototype.traverseTimeSeriesForward=function(l,m){if(l.length>0){var g=l.parents(this.container);var f=g.find(this.section).index(l);if(f>-1&&f<this.sectionDetails.length){if(m=="monthly"){var k=l.find(this.monthlyInteractiveChart);var d=k.find(this.monthlyBar);var a=k.find(this.monthlyBar+".active");var j=-1;if(d.length>0){var e=d.eq(0).attr("class").replace("active","");var b=e+" active";if(a.length>0){j=d.index(a.eq(0))}d.attr("class",e);j++;if(j>11){j=-1}else{var a=d.eq(j);a.attr("class",b)}this.updateSeriesChart(l,f,"monthly",j,"",false);this.updateBarChart(l,f,"monthly",j)}}else{var k=l.find(this.seriesChart);var h=k.find(this.dot);var c=k.find(this.dot+".active");var j=-1;if(h.length>0){var e=h.eq(0).attr("class").replace("active","");var b=e+" active";if(c.length>0){j=h.index(c.eq(0))}h.attr("class",e);j++;if(j>this.activeTheme.years.length-1){j=-1}else{var c=h.eq(j);c.attr("class",b)}this.updateBarChart(l,f,"annual",j);this.updateMonthlyInteractiveChart(l,f,"annual",j,"",false)}}}}};ChartManager.prototype.showChartPopup=function(d){var e=$(this.chartPopup);var b=$(this.chartPopupCanvas);if(d.length>0&&e.length>0&&b.length>0){var c=b.get()[0];var a=function(){c.toDataURL()};this.chartToImage(d,c,a);e.addClass("active");$(this.chartPopupCloseButton).focus()}};ChartManager.prototype.chartToImage=function(c,b,a){if(c.length>0){var j=c.get()[0];var h=new XMLSerializer();var k=h.serializeToString(j);var g=new Image();var l=600;var e=579;var f=new Image(80,55);var d=b.getContext("2d");b.width=l;b.height=e;f.onload=function(){d.save();d.globalAlpha=0.1;d.drawImage(this,189,214,222,152);d.restore()};g.onload=function(){d.drawImage(this,0,0,l,e);a()};f.src="icons/USDA-logo.png";g.src="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(k)))}};var Tour=function(d,g,j,h,c,e,a,f,b){this.openButton=d;this.stopContainer=g;this.stopNumber=j;this.stopNarrative=h;this.nextStopButton=c;this.previousStopButton=e;this.closeButton=a;this.startBookEnd=f;this.endBookend=b;this.stops=[];this.currentStop=-1;$(this.openButton).click({obj:this},function(k){k.data.obj.show()});$(this.openButton).keydown({obj:this},function(k){if(k.keyCode===13||k.keyCode===32){k.data.obj.show()}});$(this.nextStopButton).click({obj:this},function(k){k.stopPropagation();k.data.obj.nextStop()});$(this.nextStopButton).keydown({obj:this},function(k){if(k.keyCode===13||k.keyCode===32){k.stopPropagation();k.data.obj.nextStop()}});$(this.previousStopButton).click({obj:this},function(k){k.stopPropagation();k.data.obj.previousStop()});$(this.previousStopButton).keydown({obj:this},function(k){if(k.keyCode===13||k.keyCode===32){k.stopPropagation();k.data.obj.previousStop()}});$(this.closeButton).click({obj:this},function(k){k.stopPropagation();k.data.obj.hide()});$(this.closeButton).keydown({obj:this},function(k){if(k.keyCode===13||k.keyCode===32){k.stopPropagation();var l=k.data.obj;l.hide();$(l.openButton).focus()}});$(this.startBookend).keyup({obj:this},function(k){if(k.keyCode===9){var l=k.data.obj;$(l.closeButton).focus()}});$(this.endBookend).keyup({obj:this},function(k){if(k.keyCode===9){var l=k.data.obj;$(l.previousStopButton).focus()}})};Tour.prototype.addStop=function(a,d,b,c){var e={anchorElement:a,narrative:d,enterAction:b,leaveAction:c};this.stops.push(e)};Tour.prototype.show=function(){var c=this.stops.length;var b;this.currentStop=-1;for(var a=0;a<c;a++){b=this.stops[a];$(b.anchorElement).show()}if(this.controller){this.controller.hideThemePanel()}this.nextStop()};Tour.prototype.hide=function(){var c=this.stops.length;var b;this.currentStop=-1;for(var a=0;a<c;a++){b=this.stops[a];$(b.anchorElement).hide()}$(this.stopNumber).empty();$(this.stopNarrative).empty();this.currentStop=-1};Tour.prototype.nextStop=function(){var a;if(this.currentStop>-1&&this.currentStop<this.stops.length){a=this.stops[this.currentStop];if(a.leaveAction){a.leaveAction()}}this.currentStop=this.currentStop+1;if(this.currentStop<0||this.currentStop>=this.stops.length){this.currentStop=0}var a=this.stops[this.currentStop];var b=$(this.stopContainer);$(this.stopNumber).html(this.currentStop+1);$(this.stopNarrative).html(a.narrative);$(a.anchorElement).append(b);if(a.enterAction){a.enterAction()}$(this.nextStopButton).focus()};Tour.prototype.previousStop=function(){var a;if(this.currentStop>-1&&this.currentStop<this.stops.length){a=this.stops[this.currentStop];if(a.leaveAction){a.leaveAction()}}this.currentStop=this.currentStop-1;if(this.currentStop<0||this.currentStop>=this.stops.length){this.currentStop=this.stops.length-1}a=this.stops[this.currentStop];var b=$(this.stopContainer);$(this.stopNumber).html(this.currentStop+1);$(this.stopNarrative).html(a.narrative);$(a.anchorElement).append(b);if(a.enterAction){a.enterAction()}$(this.previousStopButton).focus()};var UserSurvey=function(e,c,d,b,a){this.overlay=e;this.container=c;this.openButton=d;this.closeButton=b;this.bookend=a;$(this.openButton).click({obj:this},function(f){f.stopPropagation();var g=f.data.obj;$(g.overlay).addClass("active");$(g.closeButton).focus()});$(this.openButton).keydown({obj:this},function(f){if(f.keyCode===13||f.keyCode===32){f.stopPropagation();$(this).trigger("click")}});$(this.closeButton).click({obj:this},function(f){f.stopPropagation();var g=f.data.obj;$(g.overlay).removeClass("active");$(g.openButton).focus()});$(this.closeButton).keydown({obj:this},function(f){if(f.keyCode===13||f.keyCode===32){f.stopPropagation();$(this).trigger("click")}});$(this.bookend).keyup({obj:this},function(f){if(f.keyCode===9){var g=f.data.obj;$(g.overlay).removeClass("active");$(g.openButton).focus()}})};var DownloadManager=function(m,l,c,g,f,j,e,o,k,d,b,h,n,a){this.overlay=m;this.openButton=l;this.closeButton=c;this.detailsToggle=g;this.details=f;this.metricOption=j;this.countyOption=e;this.yearOption=o;this.monthOption=k;this.commodityOption=d;this.causeOption=b;this.formatMenu=h;this.submitButton=n;this.bookend=a;$(this.openButton).click({obj:this},function(p){p.stopPropagation();var q=p.data.obj;$(q.overlay).addClass("active");$(q.closeButton).focus();q.onOpen()});$(this.openButton).keydown({obj:this},function(p){if(p.keyCode===13||p.keyCode===32){p.stopPropagation();$(this).trigger("click")}});$(this.closeButton).click({obj:this},function(p){p.stopPropagation();var q=p.data.obj;$(q.overlay).removeClass("active");$(q.openButton).focus()});$(this.closeButton).keydown({obj:this},function(p){if(p.keyCode===13||p.keyCode===32){p.stopPropagation();$(this).trigger("click")}});$(this.detailsToggle).click({obj:this},function(p){var q=p.data.obj;$(this).toggleClass("active");$(q.details).toggle()});$(this.detailsToggle).keydown({obj:this},function(p){if(p.keyCode===13||p.keyCode===32){var q=p.data.obj;$(this).toggleClass("active");$(q.details).toggle()}});$(this.submitButton).click({obj:this},function(p){p.stopPropagation();var q=p.data.obj;$(q.overlay).removeClass("active");$(q.openButton).focus();q.requestData()});$(this.submitButton).keydown({obj:this},function(p){if(p.keyCode===13||p.keyCode===32){p.stopPropagation();$(this).trigger("click")}});$(this.bookend).keyup({obj:this},function(p){if(p.keyCode===9){var q=p.data.obj;$(q.overlay).removeClass("active");$(q.openButton).focus()}})};DownloadManager.prototype.onOpen=function(){var b=this.controller;if(b){if(b.themeManager){var a=b.themeManager.getActiveTheme();var d=b.map.getSelectedFeatureList();if(a){$(this.metricOption).each(function(){if($(this).val()==a.metric){$(this).prop("checked",true)}})}if(d==""){$(this.monthOption).prop("checked",false).prop("disabled",true);$(this.commodityOption).prop("checked",false).prop("disabled",true);$(this.causeOption).prop("checked",false).prop("disabled",true)}else{$(this.monthOption).prop("disabled",false);$(this.commodityOption).prop("disabled",false);$(this.causeOption).prop("disabled",false)}}}};DownloadManager.prototype.requestData=function(){var b=this.controller;if(b){if(b.map&&b.themeManager){var a=b.themeManager.getActiveTheme();if(a){var p=a.startYear;var j=a.endYear;var f=a.commodities;var e=a.causes;var k=a.measure;var q=a.reportingUnit;var o=b.map.getSelectedFeatureList();var r="";var l="";var h="no";var t="no";var m="no";var g="no";var d="no";if(o.length>0){r=o[0]}$(this.metricOption+":checked").each(function(){l=l+$(this).val()+"|"});if(l!=""){l=l.substring(0,l.length-1)}if($(this.countyOption).is(":checked")){h="yes"}if($(this.yearOption).is(":checked")){t="yes"}if($(this.monthOption).is(":checked")){m="yes"}if($(this.commodityOption).is(":checked")){g="yes"}if($(this.causeOption).is(":checked")){d="yes"}var n={metrics:l,startYear:p,endYear:j,commodities:f,causes:e,measurementUnit:k,reportingUnit:q,reportingUnitID:r,countyColumn:h,yearColumn:t,monthColumn:m,commodityColumn:g,causeColumn:d,format:$(this.formatMenu).val()};var s="payment-formatted-data.php?"+$.param(n);window.location.href=s}}}};var controller=new ContentController("#content","#header-menu","#header-links a","#header-links span","#load-overlay","#content-loader","#map-container","#theme-container","#theme-header","#theme-page","#chart-page","#theme-button","#chart-button");var rmaMap=new RMAMap("#map-container","#rma-map","#county-layer-option","#state-layer-option","#map-theme-metric",".selection-title h3","#map-legend",".map-legend-item",".map-legend-box",".map-legend-label","#map-popup","#map-resize-button","#search-container","#search-box-wrapper","#search-box","#search-button","#search-close-button");var themeManager=new ThemeManager("#theme-content","#theme-form-container",".theme-form",".theme-parameter",".theme-form-section","scrollable","truncated","#metric-details","#date-details","#commodity-details","#cause-details","#setting-details",".option-list",".metric-option-list li",".year-option-list li",".commodity-option-list li",".cause-option-list li",".all-option",".map-class-count-menu",".map-class-method-menu",".map-measurement-unit-menu","#theme-form-clear-button","#theme-form-update-button","#theme-form-cancel-button",".theme-bookend");var chartManager=new ChartManager("#chart-page",".chart-section-container",".chart-section",".chart-title",".chart-wrapper",".series-chart",".bar-chart",".monthly-interactive-chart",".monthly-chart",".chart-variable-label",".chart-export-button",".chart-bar text",".series-chart-dot",".chart-bar",".previous-year-button",".next-year-button",".previous-month-button",".next-month-button",".series-chart-clear-button",".bar-chart-clear-button",".monthly-chart-clear-button","#chart-overlay","#chart-popup-canvas","#chart-popup-close-button");var tour=new Tour("#tour-button","#tour-stop-container","#tour-stop-number","#tour-stop-narrative","#tour-next-stop-button","#tour-previous-stop-button","#tour-close-button","#tour-start-bookend","#tour-end-bookend");tour.addStop("#tour-layer-anchor","Toggle between county and state layers.",null,null);tour.addStop("#tour-map-anchor","Click on a county or state to view data specific to that map feature. Select multiple counties by holding down the Ctrl key, and select all counties by clicking on an area outside of U.S. boundaries.",null,null);tour.addStop("#tour-search-anchor","Search for and select a state or county by name.",null,null);tour.addStop("#tour-layer-details-anchor","Details about the selected data layer are shown on the Now Viewing panel. Modify data layer parameters (e.g., commodity) by clicking on the parameter name and choosing from available options.",function(){if(controller){$(controller.themeContainer).addClass("expanded")}},function(){if(controller){$(controller.themeContainer).removeClass("expanded")}});tour.addStop("#tour-selection-details-anchor","View additional details about the selected map feature by clicking on the View Selection Details (chart) icon. A panel containing several interactive charts will be displayed. Return to the Now Viewing panel by clicking on the View Layer Details (map) icon.",function(){if(controller){$(controller.themeContainer).addClass("expanded")}},function(){if(controller){$(controller.themeContainer).removeClass("expanded")}});tour.addStop("#tour-map-settings-anchor","Change how data is displayed on the map by clicking on the Map Settings option. For example, data can be reported by either state or county.",function(){if(controller){$(controller.themeContainer).addClass("expanded")}},function(){if(controller){$(controller.themeContainer).removeClass("expanded")}});var userSurvey=new UserSurvey("#survey-overlay","#survey-container-frame","#survey-button","#survey-close-button",".survey-bookend");var downloadManager=new DownloadManager("#download-overlay",".data-button","#download-close-button","#download-message-details-toggle","#download-message-details","#download-container input[name='metric']","#download-container input[name='county']","#download-container input[name='year']","#download-container input[name='month']","#download-container input[name='commodity']","#download-container input[name='cause']","#download-format-menu","#download-button",".download-bookend");controller.addThemeManager(themeManager);controller.addMap(rmaMap);controller.addChartManager(chartManager);controller.addTour(tour);controller.addUserSurvey(userSurvey);controller.addDownloadManager(downloadManager);controller.loadContent();var qs=decodeURI(location);var tourTag=qs.indexOf("#tour");if(tourTag>-1){tour.show()};